<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Дурак: Онлайн и Офлайн</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@500&display=swap');
        
        body {
            background-color: #2e7d32;
            background-image: radial-gradient(#358e39 15%, transparent 16%), radial-gradient(#358e39 15%, transparent 16%);
            background-size: 60px 60px;
            font-family: 'Segoe UI', sans-serif;
            overflow: hidden;
            user-select: none;
            touch-action: manipulation;
        }

        /* --- STYLES --- */
        .card {
            width: 70px; height: 105px;
            background-color: white; border-radius: 6px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            display: flex; flex-direction: column; justify-content: space-between;
            padding: 4px; position: absolute;
            transition: transform 0.2s, box-shadow 0.2s, top 0.2s, left 0.2s;
            cursor: pointer; border: 1px solid #ccc;
        }
        .card:hover { transform: translateY(-10px); z-index: 50 !important; }
        .suit-red { color: #e53e3e; }
        .suit-black { color: #1a202c; }
        
        @media (min-width: 640px) {
            .card { width: 90px; height: 135px; padding: 6px; }
        }

        /* Зоны */
        #game-table {
            position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%);
            width: 100%; max-width: 700px; height: 220px;
            display: flex; justify-content: center; align-items: center; pointer-events: none;
            z-index: 10;
        }
        .table-slot { width: 80px; height: 120px; margin: 0 6px; position: relative; pointer-events: none; }

        /* Руки */
        #player-hand {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            height: 140px; width: 100%; display: flex; justify-content: center; align-items: flex-end;
            z-index: 20;
        }
        .hand-card-wrapper { margin-left: -35px; position: relative; width: 70px; height: 105px; transition: margin 0.2s; }
        .hand-card-wrapper:first-child { margin-left: 0; }
        .hand-card-wrapper:hover { margin-right: 20px; }

        #opponent-hand {
            position: absolute; top: -10px; left: 50%; transform: translateX(-50%);
            display: flex; justify-content: center;
        }
        .opponent-card-back {
            width: 50px; height: 80px; margin-left: -30px;
            background: repeating-linear-gradient(45deg, #1e3a8a, #1e3a8a 5px, #2563eb 5px, #2563eb 10px);
            border: 2px solid white; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        /* UI */
        .btn-action {
            padding: 0.8rem 2.5rem; border-radius: 12px; font-weight: 800; font-size: 1.2rem;
            box-shadow: 0 6px 0 rgba(0,0,0,0.2); transition: all 0.1s; cursor: pointer;
            border: 2px solid rgba(255,255,255,0.4); text-transform: uppercase; letter-spacing: 1px;
            pointer-events: auto;
        }
        .btn-action:active { transform: translateY(4px); box-shadow: 0 2px 0 rgba(0,0,0,0.2); }
        
        .btn-bito { background: #22c55e; color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.3); } /* Ярко-зеленый */
        .btn-bito:hover { background: #16a34a; }
        
        .btn-take { background: #ef4444; color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.3); } /* Ярко-красный */
        .btn-take:hover { background: #dc2626; }

        #lobby-screen { z-index: 1000; background: rgba(0,0,0,0.85); backdrop-filter: blur(5px); }
        #game-over-screen { z-index: 2000; background: rgba(0,0,0,0.9); backdrop-filter: blur(8px); }
    </style>
</head>
<body class="h-screen w-screen text-gray-800">

    <!-- GAME OVER SCREEN -->
    <div id="game-over-screen" class="fixed inset-0 flex items-center justify-center text-white hidden opacity-0 transition-opacity duration-500">
        <div class="text-center p-8 max-w-lg w-full transform scale-90 transition-transform duration-500" id="game-over-content">
            <h1 id="go-title" class="text-6xl font-black mb-4 text-red-500 drop-shadow-[0_5px_5px_rgba(0,0,0,0.5)]">ВЫ ПРОИГРАЛИ!</h1>
            <div id="go-message" class="text-xl text-gray-200 mb-8 italic font-serif">"..."</div>
            
            <button onclick="leaveGame()" class="bg-white text-gray-900 font-bold py-4 px-10 rounded-full hover:bg-gray-200 hover:scale-105 transition shadow-2xl text-xl">
                В меню
            </button>
        </div>
    </div>

    <!-- ЛОББИ -->
    <div id="lobby-screen" class="fixed inset-0 flex items-center justify-center text-white">
        <div class="bg-white text-gray-800 p-8 rounded-xl shadow-2xl max-w-md w-full mx-4 relative overflow-hidden">
            <h1 class="text-3xl font-bold mb-2 text-center text-blue-800">Дурак</h1>
            <p class="text-center text-gray-500 mb-6 text-sm">Pro Edition: Online & Offline</p>
            
            <div id="lobby-main" class="space-y-4">
                <button onclick="startOfflineGame()" class="w-full bg-gradient-to-r from-green-500 to-green-700 text-white font-bold py-4 rounded-lg shadow-lg hover:from-green-600 hover:to-green-800 transition transform hover:scale-105 flex items-center justify-center gap-2">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    Играть с Ботом
                </button>

                <div class="relative flex py-2 items-center">
                    <div class="flex-grow border-t border-gray-300"></div>
                    <span class="flex-shrink-0 mx-4 text-gray-400 text-xs uppercase">Или Онлайн</span>
                    <div class="flex-grow border-t border-gray-300"></div>
                </div>

                <!-- ОНЛАЙН -->
                <div id="online-controls" class="space-y-3 opacity-50 pointer-events-none transition-opacity">
                    <div class="text-xs text-center text-gray-400 mb-2" id="auth-status">
                        Требуется свой Firebase Config
                    </div>
                    
                    <button onclick="createOnlineGame()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg shadow transition">
                        Создать Онлайн Игру
                    </button>
                    <div class="flex gap-2">
                        <input id="join-game-id" type="text" placeholder="ID (6 цифр)" 
                               class="flex-1 border-2 border-gray-300 p-2 rounded-lg text-center font-mono uppercase text-sm">
                        <button onclick="joinOnlineGame()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow transition text-sm">Войти</button>
                    </div>
                </div>
            </div>

            <!-- Экран ожидания (онлайн) -->
            <div id="waiting-room" class="hidden text-center">
                <h2 class="text-xl font-bold mb-2">Ожидание игрока</h2>
                <div class="bg-yellow-100 p-4 rounded-lg mb-4 border-2 border-yellow-300">
                    <div class="text-sm text-gray-600">Код комнаты:</div>
                    <div id="display-game-id" class="text-4xl font-mono font-bold tracking-widest text-blue-700 select-all cursor-pointer" onclick="copyId()">------</div>
                </div>
                <button onclick="leaveGame()" class="text-red-500 hover:underline text-sm">Отмена</button>
            </div>
        </div>
    </div>

    <!-- ИГРОВОЙ ИНТЕРФЕЙС -->
    <div id="game-ui" class="hidden h-full w-full relative">
        <!-- Верхняя панель -->
        <div class="absolute top-0 left-0 w-full p-2 flex justify-between items-start z-10 pointer-events-none">
            <div id="status-badge" class="bg-gray-700 text-white px-4 py-2 rounded-full text-sm font-bold shadow-lg backdrop-blur-md pointer-events-auto transition-colors">
                Ожидание...
            </div>
            <div class="text-right pointer-events-auto flex flex-col items-end gap-2">
                <div class="bg-white/90 text-gray-900 px-3 py-1 rounded shadow text-sm font-bold flex items-center gap-2">
                    Козырь: <span id="trump-suit-display" class="text-xl leading-none"></span>
                </div>
                <button onclick="leaveGame()" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-xs shadow">Меню</button>
            </div>
        </div>

        <div id="opponent-hand"></div>
        <div id="opponent-name" class="absolute top-16 left-1/2 transform -translate-x-1/2 text-white/70 text-sm font-bold bg-black/20 px-2 rounded">Соперник</div>

        <div id="deck-area" class="absolute left-4 top-1/2 transform -translate-y-1/2">
            <div class="relative w-[70px] h-[105px]">
                <div id="trump-card-el" class="absolute top-0 left-0 transition-all"></div>
                <div id="deck-stack" class="absolute top-0 left-0 w-full h-full bg-blue-900 border-2 border-white rounded-lg shadow-lg flex items-center justify-center">
                    <span id="deck-count" class="text-white font-bold text-xl">36</span>
                </div>
            </div>
        </div>

        <div id="game-table"></div>

        <!-- КНОПКИ ДЕЙСТВИЙ (БИТО / БЕРУ) -->
        <!-- Максимальный Z-Index (999), без анимаций прозрачности, чтобы не было глюков -->
        <div id="action-area" class="absolute bottom-48 left-1/2 transform -translate-x-1/2 z-[999] flex gap-6 hidden">
            <button id="btn-bito" onclick="performAction('bito')" class="btn-action btn-bito hidden">
                БИТО!
            </button>
            <button id="btn-take" onclick="performAction('take')" class="btn-action btn-take hidden">
                ВЗЯТЬ
            </button>
        </div>

        <div id="player-hand"></div>

        <div id="toast" class="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-black/80 text-white px-6 py-3 rounded-xl pointer-events-none transition-all opacity-0 scale-90 z-[200]">
            Сообщение
        </div>
    </div>

    <!-- ЛОГИКА -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, updateDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const MY_CUSTOM_CONFIG = {
          apiKey: "AIzaSyBlfCYqHw_uHxP6pyKOkW0QFsuHFw9_XyY",
          authDomain: "durakweb3.firebaseapp.com",
          projectId: "durakweb3",
          storageBucket: "durakweb3.firebasestorage.app",
          messagingSenderId: "306514193440",
          appId: "1:306514193440:web:79d78252da6ee29c40a045",
          measurementId: "G-69VNYN2Z20"
        };

        const LOSER_JOKES = [
            "Ну ты даешь... даже хлеб умнее играет.",
            "Не расстраивайся, быть дураком - это призвание!",
            "У тебя карты были крапленые, я уверен. Но ты все равно проиграл.",
            "Бот просил передать, что ему было скучно.",
            "В следующий раз попробуй играть с открытыми глазами.",
            "Твой IQ равен количеству козырей в колоде.",
            "Я видел, как голуби играют лучше."
        ];

        // --- GLOBAL STATE ---
        let GAME_MODE = 'OFFLINE'; 
        let currentUser = { uid: 'player-offline' };
        let currentGameId = null;
        let unsubscribeGame = null;
        
        let localState = null;
        let botTimer = null;

        // --- FIREBASE INIT ---
        let db, auth, gamesRef;
        let isFirebaseReady = false;

        async function initFirebase() {
            try {
                let fbConfig = null;
                if (MY_CUSTOM_CONFIG) {
                    fbConfig = MY_CUSTOM_CONFIG;
                } else if (typeof __firebase_config !== 'undefined') {
                    fbConfig = JSON.parse(__firebase_config);
                }

                if (fbConfig && fbConfig.projectId) {
                    const app = initializeApp(fbConfig);
                    auth = getAuth(app);
                    db = getFirestore(app);
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default';
                    gamesRef = collection(db, 'artifacts', appId, 'public', 'data', 'games');
                    
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }

                    onAuthStateChanged(auth, (user) => {
                        if (user) {
                            currentUser = user;
                            isFirebaseReady = true;
                            const statusEl = document.getElementById('auth-status');
                            statusEl.innerText = "Сервер подключен";
                            statusEl.className = "text-xs text-center text-green-600 mb-2 font-bold";
                            document.getElementById('online-controls').classList.remove('opacity-50', 'pointer-events-none');
                        }
                    });
                }
            } catch (e) {
                console.error("Firebase Init Error:", e);
                document.getElementById('auth-status').innerText = "Ошибка: " + e.message;
            }
        }

        initFirebase();

        // --- УПРАВЛЕНИЕ ЛОББИ ---

        window.startOfflineGame = () => {
            GAME_MODE = 'OFFLINE';
            currentUser = { uid: 'player' };
            hideGameOver();
            
            const deck = createDeck();
            const trump = deck[0];
            const pHand = [];
            const bHand = [];
            for(let i=0; i<6; i++) { pHand.push(deck.pop()); bHand.push(deck.pop()); }

            let pMin = 100, bMin = 100;
            pHand.forEach(c => { if(c.suit === trump.suit && c.value < pMin) pMin = c.value; });
            bHand.forEach(c => { if(c.suit === trump.suit && c.value < bMin) bMin = c.value; });
            const playerFirst = pMin < bMin;

            localState = {
                status: 'playing',
                deck: deck,
                trumpCard: trump,
                trumpSuit: trump.suit,
                hands: { 'player': pHand, 'bot': bHand },
                table: [],
                turn: playerFirst ? 'player' : 'bot',
                attacker: playerFirst ? 'player' : 'bot',
                hostId: 'player',
                joinerId: 'bot'
            };

            showGameUI();
            renderGame(localState);
            if (localState.turn === 'bot') startBotTimer();
        }

        window.createOnlineGame = async () => {
            if (!isFirebaseReady) return showToast("Нет подключения к серверу");
            GAME_MODE = 'ONLINE';
            const gameId = Math.floor(100000 + Math.random() * 900000).toString();
            const deck = createDeck();
            
            const state = {
                hostId: currentUser.uid,
                joinerId: null,
                status: 'waiting',
                deck: deck,
                trumpCard: deck[0],
                trumpSuit: deck[0].suit,
                hands: { [currentUser.uid]: [] },
                table: [],
                turn: currentUser.uid,
                attacker: currentUser.uid,
                lastUpdate: serverTimestamp()
            };

            await setDoc(doc(gamesRef, gameId), state);
            currentGameId = gameId;
            document.getElementById('lobby-main').classList.add('hidden');
            document.getElementById('waiting-room').classList.remove('hidden');
            document.getElementById('display-game-id').innerText = gameId;
            subscribeToGame(gameId);
        };

        window.joinOnlineGame = async () => {
            if (!isFirebaseReady) return showToast("Нет подключения");
            const inputId = document.getElementById('join-game-id').value.trim();
            if (inputId.length !== 6) return showToast("Нужен ID из 6 цифр");
            GAME_MODE = 'ONLINE';

            const gameRef = doc(gamesRef, inputId);
            const snap = await getDoc(gameRef);
            if (!snap.exists()) return showToast("Игра не найдена");
            const data = snap.data();
            if (data.status !== 'waiting') return showToast("Игра занята");

            const deck = [...data.deck];
            const h1 = [], h2 = [];
            for(let i=0; i<6; i++) { if(deck.length) h1.push(deck.pop()); if(deck.length) h2.push(deck.pop()); }

            await updateDoc(gameRef, {
                joinerId: currentUser.uid,
                status: 'playing',
                deck: deck,
                [`hands.${data.hostId}`]: h1,
                [`hands.${currentUser.uid}`]: h2,
                attacker: data.hostId, 
                turn: data.hostId
            });

            currentGameId = inputId;
            subscribeToGame(inputId);
        };

        function subscribeToGame(id) {
            unsubscribeGame = onSnapshot(doc(gamesRef, id), (snap) => {
                if(!snap.exists()) return leaveGame();
                const d = snap.data();
                localState = d;
                if (d.status === 'playing') {
                    showGameUI();
                    renderGame(d);
                }
            });
        }

        // --- ОСНОВНАЯ ЛОГИКА ---

        window.playerCardClick = (card) => {
            const state = localState;
            const myUid = GAME_MODE === 'OFFLINE' ? 'player' : currentUser.uid;
            
            const isMyTurn = state.turn === myUid;
            const amIAttacker = state.attacker === myUid;
            const matchesTable = state.table.some(p => p.attack.rank === card.rank || (p.defend && p.defend.rank === card.rank));
            
            // Если не мой ход и это не подкидывание
            if (!isMyTurn && !(amIAttacker && matchesTable)) {
                return showToast("Не ваш ход! Ждите.");
            }

            if (amIAttacker) {
                if (state.table.length > 0 && !matchesTable) return showToast("Карта не совпадает по рангу");
                if (state.table.length >= 6) return showToast("Стол полон");
                
                if (GAME_MODE === 'OFFLINE' && botTimer) { clearTimeout(botTimer); botTimer = null; }
                applyMove(card, 'attack');
            } else {
                if (!isMyTurn) return showToast("Ждите хода соперника");
                
                const pairIdx = state.table.findIndex(p => !p.defend);
                if (pairIdx === -1) return; 
                
                const att = state.table[pairIdx].attack;
                if (!canBeat(card, att, state.trumpSuit)) return showToast("Этой картой нельзя побить");
                
                applyMove(card, 'defend', pairIdx);
            }
        };

        window.performAction = (type) => {
            if (GAME_MODE === 'OFFLINE' && botTimer) clearTimeout(botTimer);
            processAction(type);
        };

        async function applyMove(card, type, idx = -1) {
            const myUid = GAME_MODE === 'OFFLINE' ? 'player' : currentUser.uid;
            const oppId = GAME_MODE === 'OFFLINE' ? 'bot' : (localState.hostId === myUid ? localState.joinerId : localState.hostId);

            let newHands = { ...localState.hands };
            newHands[myUid] = newHands[myUid].filter(c => !(c.rank===card.rank && c.suit===card.suit));
            
            let newTable = [...localState.table];
            let newTurn = localState.turn;

            if (type === 'attack') {
                newTable.push({ attack: card, defend: null });
                newTurn = oppId;
                if (GAME_MODE === 'OFFLINE') startBotTimer();
            } else {
                newTable[idx] = { ...newTable[idx], defend: card };
                const hasUndefended = newTable.some(p => !p.defend);
                if (!hasUndefended) {
                    newTurn = localState.attacker;
                    if (GAME_MODE === 'OFFLINE') startBotTimer();
                }
            }

            if (GAME_MODE === 'ONLINE') {
                await updateDoc(doc(gamesRef, currentGameId), {
                    [`hands.${myUid}`]: newHands[myUid],
                    table: newTable,
                    turn: newTurn
                });
            } else {
                localState.hands = newHands;
                localState.table = newTable;
                localState.turn = newTurn;
                renderGame(localState);
            }
        }

        async function processAction(action) {
            const myUid = GAME_MODE === 'OFFLINE' ? 'player' : currentUser.uid;
            const oppId = GAME_MODE === 'OFFLINE' ? 'bot' : (localState.hostId === myUid ? localState.joinerId : localState.hostId);
            
            let d = [...localState.deck];
            let h = JSON.parse(JSON.stringify(localState.hands));
            let t = [];
            let newAttacker = localState.attacker;
            let newTurn = localState.turn;

            if (action === 'bito') {
                [myUid, oppId].forEach(uid => {
                    while(h[uid].length < 6 && d.length > 0) h[uid].push(d.pop());
                });
                newAttacker = oppId; 
                newTurn = oppId;
                if (GAME_MODE === 'OFFLINE') startBotTimer();

            } else if (action === 'take') {
                let cardsToTake = [];
                localState.table.forEach(p => { cardsToTake.push(p.attack); if(p.defend) cardsToTake.push(p.defend); });
                h[myUid] = [...h[myUid], ...cardsToTake];
                
                while(h[oppId].length < 6 && d.length > 0) h[oppId].push(d.pop());
                
                newAttacker = oppId; 
                newTurn = oppId;
                if (GAME_MODE === 'OFFLINE') startBotTimer();
            }

            if (GAME_MODE === 'ONLINE') {
                await updateDoc(doc(gamesRef, currentGameId), {
                    deck: d, hands: h, table: t, attacker: newAttacker, turn: newTurn
                });
            } else {
                localState.deck = d; localState.hands = h; localState.table = t;
                localState.attacker = newAttacker; localState.turn = newTurn;
                renderGame(localState);
            }
        }

        // --- ЛОГИКА БОТА ---

        function startBotTimer() {
            if (botTimer) clearTimeout(botTimer);
            botTimer = setTimeout(botTurn, 1000 + Math.random() * 500);
        }

        function botTurn() {
            if (!localState || GAME_MODE !== 'OFFLINE') return;
            const state = localState;
            if (checkGameOver(state)) return;

            const botHand = state.hands['bot'];
            const amIAttacker = state.attacker === 'bot';

            if (amIAttacker) {
                if (state.table.length === 0) {
                    const c = getLowestCard(botHand, state.trumpSuit);
                    botApplyMove(c, 'attack');
                } else {
                    const ranks = new Set();
                    state.table.forEach(p => { ranks.add(p.attack.rank); if(p.defend) ranks.add(p.defend.rank); });
                    const options = botHand.filter(c => ranks.has(c.rank)).sort((a,b) => getCardPower(a, state.trumpSuit) - getCardPower(b, state.trumpSuit));
                    
                    if (options.length > 0 && state.table.length < 6) {
                        botApplyMove(options[0], 'attack');
                    } else {
                        processAction('bito'); 
                    }
                }
            } else {
                const pairIdx = state.table.findIndex(p => !p.defend);
                
                if (pairIdx === -1) { return; }

                const att = state.table[pairIdx].attack;
                let beaters = botHand.filter(c => canBeat(c, att, state.trumpSuit));
                
                if (beaters.length > 0) {
                    beaters.sort((a,b) => getCardPower(a, state.trumpSuit) - getCardPower(b, state.trumpSuit));
                    botApplyMove(beaters[0], 'defend', pairIdx);
                } else {
                    processAction('take'); 
                }
            }
        }

        function botApplyMove(card, type, idx) {
            const state = localState;
            state.hands['bot'] = state.hands['bot'].filter(c => c !== card);
            
            if (type === 'attack') {
                state.table.push({ attack: card, defend: null });
                state.turn = 'player';
            } else {
                state.table[idx].defend = card;
                const hasUndefended = state.table.some(p => !p.defend);
                if (hasUndefended) {
                    state.turn = 'bot'; startBotTimer();
                } else {
                    state.turn = 'player';
                }
            }
            renderGame(state);
        }

        // --- UI RENDER ---

        function checkGameOver(state) {
            if (state.deck.length === 0) {
                const myUid = GAME_MODE === 'OFFLINE' ? 'player' : currentUser.uid;
                const oppUid = GAME_MODE === 'OFFLINE' ? 'bot' : (state.hostId === myUid ? state.joinerId : state.hostId);
                const myH = state.hands[myUid].length;
                const oppH = state.hands[oppUid].length;
                
                if (myH === 0 && oppH === 0) { showGameOver('draw'); return true; }
                if (myH === 0) { showGameOver('win'); return true; }
                if (oppH === 0) { showGameOver('lose'); return true; }
            }
            return false;
        }

        function renderGame(state) {
            if (checkGameOver(state)) return;

            const myUid = GAME_MODE === 'OFFLINE' ? 'player' : currentUser.uid;
            const oppUid = GAME_MODE === 'OFFLINE' ? 'bot' : (state.hostId === myUid ? state.joinerId : state.hostId);
            const isMyTurn = state.turn === myUid;
            const amIAttacker = state.attacker === myUid;
            
            // Badge
            const badge = document.getElementById('status-badge');
            if (isMyTurn) {
                badge.innerText = amIAttacker ? "Ваш ход: Атакуйте" : "Ваш ход: Отбивайтесь";
                badge.className = "px-4 py-2 rounded-full text-sm font-bold shadow-lg bg-green-600 text-white animate-pulse";
            } else {
                if (amIAttacker) {
                    badge.innerText = "Подкиньте или нажмите Бито";
                    badge.className = "px-4 py-2 rounded-full text-sm font-bold shadow-lg bg-yellow-600 text-white";
                } else {
                    badge.innerText = "Соперник думает...";
                    badge.className = "px-4 py-2 rounded-full text-sm font-bold shadow-lg bg-gray-700 text-white";
                }
            }

            // Cards Info
            const trump = state.trumpCard;
            document.getElementById('trump-suit-display').innerHTML = `<span class="${(trump.suit==='hearts'||trump.suit==='diamonds')?'text-red-500':'text-gray-900'}">${getSuitChar(trump.suit)}</span>`;
            document.getElementById('deck-count').innerText = state.deck.length;
            const tEl = document.getElementById('trump-card-el');
            tEl.innerHTML = renderCardHTML(trump);
            tEl.style.transform = 'rotate(90deg) translateX(30px)';
            if(state.deck.length===0) { document.getElementById('deck-stack').classList.add('hidden'); tEl.style.opacity='0.5'; }
            else { document.getElementById('deck-stack').classList.remove('hidden'); tEl.style.opacity='1'; }

            // Table
            const tableEl = document.getElementById('game-table');
            tableEl.innerHTML = '';
            state.table.forEach(pair => {
                const slot = document.createElement('div'); slot.className = 'table-slot';
                const att = document.createElement('div'); att.className = 'card'; att.innerHTML = renderCardHTML(pair.attack);
                slot.appendChild(att);
                if(pair.defend) {
                    const def = document.createElement('div'); def.className = 'card'; def.style.top='20px'; def.style.left='20px'; def.style.zIndex=10;
                    def.innerHTML = renderCardHTML(pair.defend); slot.appendChild(def);
                }
                tableEl.appendChild(slot);
            });

            // Hands
            const handEl = document.getElementById('player-hand');
            handEl.innerHTML = '';
            state.hands[myUid].sort((a,b) => getCardPower(a, state.trumpSuit) - getCardPower(b, state.trumpSuit))
                .forEach(card => {
                    const w = document.createElement('div'); w.className = 'hand-card-wrapper';
                    const c = document.createElement('div'); c.className = 'card hover:ring-2 ring-blue-400';
                    c.innerHTML = renderCardHTML(card);
                    c.onclick = () => playerCardClick(card);
                    w.appendChild(c); handEl.appendChild(w);
                });

            const oppHandEl = document.getElementById('opponent-hand');
            oppHandEl.innerHTML = '';
            for(let i=0; i<state.hands[oppUid].length; i++) {
                const b = document.createElement('div'); b.className = 'opponent-card-back'; oppHandEl.appendChild(b);
            }

            // УПРАВЛЕНИЕ КНОПКАМИ БИТО/ВЗЯТЬ
            const btnArea = document.getElementById('action-area');
            const btnBito = document.getElementById('btn-bito');
            const btnTake = document.getElementById('btn-take');
            
            // Сбрасываем видимость (скрываем всё по умолчанию)
            btnArea.classList.add('hidden');
            btnBito.classList.add('hidden');
            btnTake.classList.add('hidden');

            if (state.table.length > 0) {
                if (amIAttacker) {
                    // АТАКА: Кнопка БИТО, если все отбито
                    const allDefended = state.table.every(p => p.defend);
                    if (allDefended) {
                        btnArea.classList.remove('hidden');
                        btnBito.classList.remove('hidden');
                    }
                } else {
                    // ЗАЩИТА: Кнопка ВЗЯТЬ (только если мой ход)
                    if (isMyTurn) {
                        btnArea.classList.remove('hidden');
                        btnTake.classList.remove('hidden');
                    }
                }
            }
        }

        // --- HELPERS ---
        function canBeat(c, a, t) {
            if(c.suit===a.suit) return c.value>a.value;
            if(c.suit===t && a.suit!==t) return true;
            return false;
        }
        function getCardPower(c, t) { return c.value + (c.suit===t?20:0); }
        function getLowestCard(h, t) { if(!h.length)return null; return h.reduce((p,c)=>getCardPower(p,t)<getCardPower(c,t)?p:c); }
        
        function showGameOver(res) {
            const sc = document.getElementById('game-over-screen');
            const ti = document.getElementById('go-title');
            const ms = document.getElementById('go-message');
            const co = document.getElementById('game-over-content');
            sc.classList.remove('hidden');
            setTimeout(()=>{sc.classList.remove('opacity-0'); co.classList.remove('scale-90'); co.classList.add('scale-100');},50);
            if(res==='win'){ti.innerText="ПОБЕДА!";ti.className="text-6xl font-black mb-4 text-green-500";ms.innerText="Красава!";}
            else if(res==='lose'){ti.innerText="ВЫ ПРОИГРАЛИ";ti.className="text-6xl font-black mb-4 text-red-600";ms.innerText=`"${LOSER_JOKES[Math.floor(Math.random()*LOSER_JOKES.length)]}"`;}
            else{ti.innerText="НИЧЬЯ";ti.className="text-6xl font-black mb-4 text-yellow-400";ms.innerText="Мир!";}
        }

        function createDeck() {
            const s=['hearts','diamonds','clubs','spades'], r=['6','7','8','9','10','J','Q','K','A'], v={'6':6,'7':7,'8':8,'9':9,'10':10,'J':11,'Q':12,'K':13,'A':14};
            let d=[]; for(let su of s)for(let ra of r)d.push({suit:su,rank:ra,value:v[ra]});
            for(let i=d.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[d[i],d[j]]=[d[j],d[i]];}
            return d;
        }
        function renderCardHTML(c) {
            const col=(c.suit==='hearts'||c.suit==='diamonds')?'suit-red':'suit-black';
            return `<div class="text-left font-bold text-sm leading-none ${col}">${c.rank}</div><div class="flex-grow flex items-center justify-center text-3xl ${col}">${getSuitChar(c.suit)}</div><div class="text-right font-bold text-sm leading-none transform rotate-180 ${col}">${c.rank}</div>`;
        }
        function getSuitChar(s) { return {'hearts':'♥','diamonds':'♦','clubs':'♣','spades':'♠'}[s]; }
        window.hideGameOver=()=>{document.getElementById('game-over-screen').classList.add('hidden','opacity-0');}
        window.showGameUI=()=>{document.getElementById('lobby-screen').classList.add('hidden');document.getElementById('game-ui').classList.remove('hidden');}
        window.leaveGame=()=>{if(unsubscribeGame)unsubscribeGame();location.reload();}
        window.copyId=()=>{navigator.clipboard.writeText(currentGameId);showToast("ID скопирован");}
        window.showToast=(m)=>{const t=document.getElementById('toast');t.innerText=m;t.classList.remove('opacity-0','scale-90');setTimeout(()=>t.classList.add('opacity-0','scale-90'),2000);}
    </script>
</body>
</html>мм
