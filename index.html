<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Durak Online</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --bg-color: #2a5c32;
            --card-width: 70px;
            --card-height: 100px;
            --btn-color: #ffcc00;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: white;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100vh;
            user-select: none;
        }

        /* --- –ú–ï–ù–Æ --- */
        #menu-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-color);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 20px;
        }

        .menu-title {
            font-size: 32px;
            font-weight: bold;
            color: var(--btn-color);
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        input {
            padding: 12px;
            border-radius: 10px;
            border: 2px solid #fff;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 16px;
            text-align: center;
            width: 200px;
            outline: none;
        }
        
        input::placeholder { color: rgba(255,255,255,0.6); }

        .menu-btn {
            background: var(--btn-color);
            color: #333;
            border: none;
            padding: 15px 40px;
            border-radius: 25px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px #c29d00;
            transition: transform 0.1s;
            width: 220px;
        }

        .menu-btn:active {
            transform: translateY(4px);
            box-shadow: 0 0 #c29d00;
        }

        .loader {
            border: 4px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top: 4px solid var(--btn-color);
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            display: none;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- –ò–ì–†–û–í–û–ô –≠–ö–†–ê–ù --- */
        #game-screen {
            display: none; /* –°–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
            flex: 1;
            position: relative;
            flex-direction: column;
        }

        /* –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å –∏–Ω—Ñ–æ */
        .top-bar {
            padding: 10px;
            display: flex;
            justify-content: space-between;
            background: rgba(0,0,0,0.2);
            font-size: 14px;
        }

        .game-code {
            font-family: monospace;
            background: rgba(0,0,0,0.4);
            padding: 2px 6px;
            border-radius: 4px;
            cursor: pointer;
        }

        /* –°—Ç–æ–ª */
        #game-area {
            flex: 1;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        /* –ö–æ–ª–æ–¥–∞ –∏ –∫–æ–∑—ã—Ä—å */
        .deck-area {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            align-items: center;
        }

        .trump-card-container {
            position: relative;
            width: var(--card-width);
            height: var(--card-height);
            margin-right: -25px; 
            box-shadow: -2px 2px 5px rgba(0,0,0,0.3);
            border-radius: 8px;
            z-index: 0;
            background: white;
        }

        .trump-inner-text {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
        }
        .trump-rank-text { font-size: 36px; font-weight: 900; line-height: 1; }
        .trump-suit-text { font-size: 32px; line-height: 1; margin-top: 5px; }

        .deck-stack {
            background: #1a3c22;
            border: 2px solid #fff;
            border-radius: 8px;
            width: var(--card-width);
            height: var(--card-height);
            z-index: 10;
            display: flex; justify-content: center; align-items: center;
            background-image: repeating-linear-gradient(45deg, #1a3c22 0, #1a3c22 10px, #142e1a 10px, #142e1a 20px);
            box-shadow: -4px 0px 10px rgba(0,0,0,0.5);
        }

        /* –°–ª–æ—Ç—ã –∫–∞—Ä—Ç –Ω–∞ —Å—Ç–æ–ª–µ */
        .table-slots {
            display: flex; gap: 10px; min-height: 120px; z-index: 10;
            padding: 0 10px; justify-content: center; flex-wrap: wrap; width: 100%;
        }

        .slot { width: var(--card-width); height: var(--card-height); position: relative; }
        .slot .card { position: absolute; top: 0; left: 0; }
        .slot .card.defending { top: 15px; left: 15px; transform: rotate(10deg); z-index: 2; }

        /* –†—É–∫–∏ */
        .hand {
            display: flex; justify-content: center; padding: 10px; gap: -20px;
            height: 120px; width: 100%; box-sizing: border-box;
        }
        .opponent-hand { position: absolute; top: 30px; transform: rotate(180deg); }
        .player-hand { position: absolute; bottom: 70px; overflow-x: auto; padding: 0 30px; }

        /* –ö–∞—Ä—Ç–∞ */
        .card {
            width: var(--card-width); height: var(--card-height);
            background: white; border-radius: 8px; color: black;
            display: flex; flex-direction: column; justify-content: space-between;
            padding: 5px; box-sizing: border-box; font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            cursor: pointer; position: relative;
        }
        .card.red { color: #d40000; }
        .card.black { color: #000; }
        .card-back {
            background: #1a3c22;
            background-image: repeating-linear-gradient(45deg, #376340 0, #376340 10px, #2a5c32 10px, #2a5c32 20px);
            border: 2px solid white;
        }
        .card.selected { transform: translateY(-20px); border: 2px solid gold; box-shadow: 0 0 10px gold; }
        .card-center { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 24px; }

        /* –ö–Ω–æ–ø–∫–∏ */
        .controls {
            position: absolute; bottom: 15px; width: 100%;
            display: flex; justify-content: center; gap: 20px;
        }
        .game-btn {
            background: var(--btn-color); border: none; padding: 12px 30px;
            border-radius: 25px; font-size: 16px; font-weight: bold; color: #333;
            box-shadow: 0 4px #c29d00; cursor: pointer;
        }
        .game-btn:active { transform: translateY(4px); box-shadow: 0 0 #c29d00; }
        .game-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; filter: grayscale(1); }
        .btn-take { background: #ff4d4d; color: white; box-shadow: 0 4px #b30000; }
        
        .status-msg {
            position: absolute; top: 50%; width: 100%; text-align: center;
            font-size: 24px; text-shadow: 0 2px 4px rgba(0,0,0,0.8);
            pointer-events: none; z-index: 100; transform: translateY(-50%);
            background: rgba(0,0,0,0.5); padding: 10px 0;
        }
    </style>
</head>
<body>

    <!-- –≠–ö–†–ê–ù –ú–ï–ù–Æ -->
    <div id="menu-screen">
        <div class="menu-title">Durak Online</div>
        <input type="text" id="player-name" placeholder="–í–∞—à–µ –∏–º—è" maxlength="10">
        
        <button class="menu-btn" onclick="createGame()">–°–æ–∑–¥–∞—Ç—å –∏–≥—Ä—É</button>
        
        <div style="display:flex; gap:10px; align-items:center;">
            <input type="text" id="join-code" placeholder="–ö–æ–¥ –∏–≥—Ä—ã" style="width: 120px;">
            <button class="menu-btn" onclick="joinGameInput()" style="width: auto; padding: 12px 20px;">–í–æ–π—Ç–∏</button>
        </div>

        <div id="menu-error" style="color: #ff4d4d; font-weight: bold;"></div>
        <div class="loader" id="menu-loader"></div>
    </div>

    <!-- –ò–ì–†–û–í–û–ô –≠–ö–†–ê–ù -->
    <div id="game-screen">
        <div class="top-bar">
            <div>–í—ã: <b id="ui-my-name">...</b></div>
            <div onclick="copyCode()" class="game-code">–ö–æ–¥: <span id="ui-game-code">...</span> üìã</div>
            <div>–°–æ–ø–µ—Ä–Ω–∏–∫: <b id="ui-opp-name">–û–∂–∏–¥–∞–Ω–∏–µ...</b></div>
        </div>

        <div id="game-area">
            <div class="hand opponent-hand" id="opponent-hand"></div>

            <div class="deck-area">
                <div id="trump-placeholder"></div>
                <div class="deck-stack" id="deck-count">36</div>
            </div>

            <div class="table-slots" id="table"></div>
            <div class="hand player-hand" id="player-hand"></div>
            
            <div class="status-msg" id="status-display" style="display:none;"></div>

            <div class="controls">
                <button id="btn-action" class="game-btn" onclick="doAction()" disabled>–ñ–¥–µ–º...</button>
            </div>
        </div>
    </div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    // --- FIREBASE SETUP ---
    const firebaseConfig = JSON.parse(__firebase_config);
    const app = firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

    // --- STATE ---
    let myId = null;
    let myName = "";
    let gameId = null;
    let unsubscribe = null;
    let gameState = null;
    let selectedCard = null;

    // –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –∫–∞—Ä—Ç
    const SUITS = ['‚ô†', '‚ô£', '‚ô¶', '‚ô•'];
    const RANKS = ['6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A'];
    const VALUES = { '6':6, '7':7, '8':8, '9':9, '10':10, 'J':11, 'Q':12, 'K':13, 'A':14 };

    // --- –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø ---
    (async () => {
        try {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await auth.signInWithCustomToken(__initial_auth_token);
            } else {
                await auth.signInAnonymously();
            }
            // –°–ª—É—à–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
            auth.onAuthStateChanged((user) => {
                if (user) {
                    myId = user.uid;
                    console.log("Logged in as:", myId);
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–µ –∏–º—è
                    const savedName = localStorage.getItem('durak_name');
                    if (savedName) document.getElementById('player-name').value = savedName;
                }
            });
        } catch (e) {
            console.error("Auth error:", e);
            showError("–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è");
        }
    })();

    // --- –§–£–ù–ö–¶–ò–ò –ú–ï–ù–Æ ---

    function showError(msg) {
        const el = document.getElementById('menu-error');
        el.innerText = msg;
        setTimeout(() => el.innerText = '', 3000);
    }

    function toggleLoader(show) {
        document.getElementById('menu-loader').style.display = show ? 'block' : 'none';
    }

    async function createGame() {
        const nameInput = document.getElementById('player-name').value.trim();
        if (!nameInput) return showError("–í–≤–µ–¥–∏—Ç–µ –∏–º—è");
        
        myName = nameInput;
        localStorage.setItem('durak_name', myName);
        toggleLoader(true);

        try {
            // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–≥—Ä—ã
            const newDeck = generateDeck();
            const trumpCard = newDeck[0];
            const deckToPlay = newDeck; // –í –¥—É—Ä–∞–∫–µ –∫–æ–∑—ã—Ä—å - –Ω–∏–∂–Ω—è—è, –æ–Ω–∞ —á–∞—Å—Ç—å –∫–æ–ª–æ–¥—ã

            const newGameId = Math.random().toString(36).substr(2, 6).toUpperCase();
            const gameRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('durak_games').doc(newGameId);

            const initialHand = [];
            // –†–∞–∑–¥–∞–µ–º —Å–µ–±–µ 6 –∫–∞—Ä—Ç
            for(let i=0; i<6; i++) initialHand.push(deckToPlay.pop());
            sortHand(initialHand, trumpCard.suit);

            await gameRef.set({
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                hostId: myId,
                status: 'waiting', // waiting, playing, finished
                deck: deckToPlay,
                trump: { rank: trumpCard.rank, suit: trumpCard.suit, isRed: isRed(trumpCard.suit) },
                trumpSuit: trumpCard.suit,
                players: {
                    [myId]: { name: myName, hand: initialHand }
                },
                table: [], // {attack: card, defend: card}
                currentTurn: myId, // –ö—Ç–æ —Ö–æ–¥–∏—Ç (–∞—Ç–∞–∫—É–µ—Ç)
                defenderId: null, // –ö—Ç–æ –æ—Ç–±–∏–≤–∞–µ—Ç—Å—è (–±—É–¥–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –∫–æ–≥–¥–∞ –≤—Ç–æ—Ä–æ–π –∏–≥—Ä–æ–∫ –≤–æ–π–¥–µ—Ç)
                winner: null
            });

            gameId = newGameId;
            startGameListener();

        } catch (e) {
            console.error(e);
            showError("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è");
        } finally {
            toggleLoader(false);
        }
    }

    async function joinGameInput() {
        const code = document.getElementById('join-code').value.trim().toUpperCase();
        const nameInput = document.getElementById('player-name').value.trim();
        if (!code) return showError("–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥");
        if (!nameInput) return showError("–í–≤–µ–¥–∏—Ç–µ –∏–º—è");

        myName = nameInput;
        localStorage.setItem('durak_name', myName);
        toggleLoader(true);

        try {
            const gameRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('durak_games').doc(code);
            const doc = await gameRef.get();

            if (!doc.exists) throw new Error("–ò–≥—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");
            const data = doc.data();

            if (data.status !== 'waiting') throw new Error("–ò–≥—Ä–∞ —É–∂–µ –∏–¥–µ—Ç");
            if (data.players[myId]) {
                 // –£–∂–µ –≤ –∏–≥—Ä–µ (–ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ)
            } else {
                // –ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–µ–º—Å—è
                const deck = data.deck;
                const myHand = [];
                for(let i=0; i<6; i++) {
                    if(deck.length > 0) myHand.push(deck.pop());
                }
                sortHand(myHand, data.trumpSuit);

                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫—Ç–æ —Ö–æ–¥–∏—Ç –ø–µ—Ä–≤—ã–º (—É–ø—Ä–æ—â–µ–Ω–Ω–æ: —Ö–æ—Å—Ç –≤—Å–µ–≥–¥–∞ –∞—Ç–∞–∫—É–µ—Ç –ø–µ—Ä–≤—ã–º –≤ –ø–µ—Ä–≤–æ–π –ø–∞—Ä—Ç–∏–∏)
                // –ò–ª–∏ –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –ø–æ–∏—Å–∫ –º–ª–∞–¥—à–µ–≥–æ –∫–æ–∑—ã—Ä—è, –Ω–æ –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –Ω–∞—á–Ω–µ–º —Å —Ö–æ—Å—Ç–∞.
                
                await gameRef.update({
                    [`players.${myId}`]: { name: myName, hand: myHand },
                    deck: deck,
                    status: 'playing',
                    defenderId: myId, // –ï—Å–ª–∏ —Ö–æ—Å—Ç –∞—Ç–∞–∫—É–µ—Ç, —Ç–æ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–≤—à–∏–π—Å—è –∑–∞—â–∏—â–∞–µ—Ç—Å—è
                    playerIds: [data.hostId, myId] // –î–ª—è —É–¥–æ–±—Å—Ç–≤–∞
                });
            }

            gameId = code;
            startGameListener();

        } catch (e) {
            console.error(e);
            showError(e.message || "–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞");
        } finally {
            toggleLoader(false);
        }
    }

    function startGameListener() {
        document.getElementById('menu-screen').style.display = 'none';
        document.getElementById('game-screen').style.display = 'flex';
        document.getElementById('ui-game-code').innerText = gameId;
        document.getElementById('ui-my-name').innerText = myName;

        const gameRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('durak_games').doc(gameId);

        unsubscribe = gameRef.onSnapshot((doc) => {
            if (!doc.exists) {
                alert("–ò–≥—Ä—É —É–¥–∞–ª–∏–ª–∏");
                location.reload();
                return;
            }
            gameState = doc.data();
            renderGame();
        });
    }

    function copyCode() {
        const code = document.getElementById('ui-game-code').innerText;
        navigator.clipboard.writeText(code);
        tg.showAlert(`–ö–æ–¥ ${code} —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω! –û—Ç–ø—Ä–∞–≤—å –¥—Ä—É–≥—É.`);
    }

    // --- –õ–û–ì–ò–ö–ê –ò–ì–†–´ (–û–ù–õ–ê–ô–ù) ---

    function renderGame() {
        if (!gameState) return;

        // 1. –û–ø–ø–æ–Ω–µ–Ω—Ç
        const playerIds = Object.keys(gameState.players);
        const opponentId = playerIds.find(id => id !== myId);
        const opponentData = opponentId ? gameState.players[opponentId] : null;

        if (opponentData) {
            document.getElementById('ui-opp-name').innerText = opponentData.name;
            renderOpponentHand(opponentData.hand.length);
        } else {
            document.getElementById('ui-opp-name').innerText = "–ñ–¥–µ–º –∏–≥—Ä–æ–∫–∞...";
            document.getElementById('opponent-hand').innerHTML = '';
        }

        // 2. –ú–æ—è —Ä—É–∫–∞
        const myData = gameState.players[myId];
        renderMyHand(myData ? myData.hand : []);

        // 3. –°—Ç–æ–ª
        renderTable(gameState.table);

        // 4. –ö–æ–ª–æ–¥–∞ –∏ –∫–æ–∑—ã—Ä—å
        renderDeck(gameState.deck.length, gameState.trump);

        // 5. –°—Ç–∞—Ç—É—Å –∏ –∫–Ω–æ–ø–∫–∏
        updateControls();
    }

    function renderOpponentHand(count) {
        const container = document.getElementById('opponent-hand');
        container.innerHTML = '';
        for (let i = 0; i < count; i++) {
            const cardEl = document.createElement('div');
            cardEl.className = 'card card-back';
            // –ù–µ–º–Ω–æ–≥–æ —Å–º–µ—â–∞–µ–º –¥–ª—è –≤–µ–µ—Ä–∞
            cardEl.style.transform = `translateX(${i * -40}px)`; // –ö–∞—Ä—Ç—ã —Å–ª–∏–ø–∞—é—Ç—Å—è
            cardEl.style.position = 'relative'; 
            cardEl.style.marginRight = '-40px'; 
            container.appendChild(cardEl);
        }
    }

    function renderMyHand(hand) {
        const container = document.getElementById('player-hand');
        container.innerHTML = '';
        hand.forEach((card, index) => {
            const cardEl = createCardElement(card);
            cardEl.onclick = () => onCardClick(card, index);
            if (selectedCard && isCardsEqual(selectedCard, card)) {
                cardEl.classList.add('selected');
            }
            container.appendChild(cardEl);
        });
    }

    function createCardElement(card) {
        const el = document.createElement('div');
        el.className = `card ${isRed(card.suit) ? 'red' : 'black'}`;
        el.innerHTML = `
            <div style="font-size: 14px; line-height: 1;">${card.rank}</div>
            <div style="font-size: 14px; text-align: right; line-height: 1;">${card.suit}</div>
            <div class="card-center">${card.suit}</div>
        `;
        return el;
    }

    function renderTable(table) {
        const container = document.getElementById('table');
        container.innerHTML = '';
        table.forEach(pair => {
            const slot = document.createElement('div');
            slot.className = 'slot';
            slot.appendChild(createCardElement(pair.attack));
            if (pair.defend) {
                const def = createCardElement(pair.defend);
                def.classList.add('defending');
                slot.appendChild(def);
            }
            container.appendChild(slot);
        });
    }

    function renderDeck(count, trump) {
        const placeholder = document.getElementById('trump-placeholder');
        placeholder.innerHTML = '';
        const deckCountEl = document.getElementById('deck-count');

        if (count > 0) {
            // –†–∏—Å—É–µ–º –∫–æ–∑—ã—Ä—å
            const trumpEl = document.createElement('div');
            trumpEl.className = `card trump-card-container ${trump.isRed ? 'red' : 'black'}`;
            trumpEl.innerHTML = `
                <div class="trump-inner-text">
                    <div class="trump-rank-text">${trump.rank}</div>
                    <div class="trump-suit-text">${trump.suit}</div>
                </div>
            `;
            placeholder.appendChild(trumpEl);
            
            deckCountEl.style.display = 'flex';
            deckCountEl.innerText = count;
        } else {
            // –ö–æ–ª–æ–¥–∞ –ø—É—Å—Ç–∞, –Ω–æ –µ—Å–ª–∏ –µ—Å—Ç—å –∫–æ–∑—ã—Ä—å, –æ–Ω –º–æ–∂–µ—Ç –æ—Å—Ç–∞—Ç—å—Å—è –ø–æ—Å–ª–µ–¥–Ω–∏–º?
            // –í –Ω–∞—à–µ–π –ª–æ–≥–∏–∫–µ deck –≤–∫–ª—é—á–∞–µ—Ç –∫–æ–∑—ã—Ä—è, —Ç–∞–∫ —á—Ç–æ –µ—Å–ª–∏ 0 - –∑–Ω–∞—á–∏—Ç –≤—Å—ë.
            deckCountEl.style.display = 'none';
        }
    }

    function updateControls() {
        const btn = document.getElementById('btn-action');
        const statusEl = document.getElementById('status-display');
        
        if (gameState.status === 'waiting') {
            statusEl.innerText = "–û–∂–∏–¥–∞–Ω–∏–µ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞...";
            statusEl.style.display = 'block';
            btn.disabled = true;
            btn.innerText = "–ñ–¥–µ–º...";
            return;
        }

        const isMyTurn = gameState.currentTurn === myId;
        const isDefender = gameState.defenderId === myId;

        // –õ–æ–≥–∏–∫–∞ —Ç–µ–∫—Å—Ç–∞ —Å—Ç–∞—Ç—É—Å–∞
        if (isMyTurn) {
            statusEl.innerText = "–í–ê–® –•–û–î (–ê—Ç–∞–∫–∞)";
            statusEl.style.background = "rgba(0, 200, 0, 0.5)";
        } else if (isDefender) {
            statusEl.innerText = "–í–ê–® –•–û–î (–ó–∞—â–∏—Ç–∞)";
            statusEl.style.background = "rgba(200, 0, 0, 0.5)";
        } else {
            statusEl.innerText = "–•–æ–¥ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞...";
            statusEl.style.background = "rgba(0,0,0,0.5)";
        }
        statusEl.style.display = 'block';

        // –õ–æ–≥–∏–∫–∞ –∫–Ω–æ–ø–∫–∏
        btn.disabled = true;
        btn.className = "game-btn";

        if (isMyTurn) { // –Ø –ê–¢–ê–ö–£–Æ
            if (gameState.table.length > 0) {
                // –ï—Å–ª–∏ –≤—Å–µ –∫–∞—Ä—Ç—ã –ø–æ–±–∏—Ç—ã - –º–æ–∂–Ω–æ –Ω–∞–∂–∞—Ç—å –ë–ò–¢–û
                const allBeaten = gameState.table.every(p => p.defend);
                if (allBeaten) {
                    btn.innerText = "–ë–ò–¢–û";
                    btn.disabled = false;
                    btn.onclick = actionBito;
                } else {
                    btn.innerText = "–ñ–¥–µ–º –∑–∞—â–∏—Ç—ã...";
                }
            } else {
                btn.innerText = "–ö–∏–¥–∞–π –∫–∞—Ä—Ç—É";
            }
        } else if (isDefender) { // –Ø –ó–ê–©–ò–©–ê–Æ–°–¨
            btn.innerText = "–í–ó–Ø–¢–¨";
            btn.className = "game-btn btn-take";
            btn.disabled = false;
            btn.onclick = actionTake;
        } else {
            // –Ø –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—å? (–Ω–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –≤ –∏–≥—Ä–µ 1 –Ω–∞ 1)
            btn.innerText = "...";
        }
    }

    // --- –î–ï–ô–°–¢–í–ò–Ø –ò–ì–†–û–ö–ê ---

    function onCardClick(card, index) {
        if (gameState.status !== 'playing') return;
        
        const isMyTurn = gameState.currentTurn === myId; // –ê—Ç–∞–∫—É—é—â–∏–π
        const isDefender = gameState.defenderId === myId; // –ó–∞—â–∏—â–∞—é—â–∏–π—Å—è

        if (isMyTurn) {
            // –ê–¢–ê–ö–ê / –ü–û–î–ö–ò–î–´–í–ê–ù–ò–ï
            // –ü—Ä–∞–≤–∏–ª–∞: 
            // 1. –ü—É—Å—Ç–æ–π —Å—Ç–æ–ª - –ª—é–±–∞—è –∫–∞—Ä—Ç–∞.
            // 2. –ù–µ –ø—É—Å—Ç–æ–π - —Ä–∞–Ω–≥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∞ —Å—Ç–æ–ª–µ.
            // 3. –ù–µ –±–æ–ª—å—à–µ 6 –∫–∞—Ä—Ç.
            // 4. –ù–µ –±–æ–ª—å—à–µ, —á–µ–º –∫–∞—Ä—Ç —É –∑–∞—â–∏—â–∞—é—â–µ–≥–æ—Å—è.

            if (gameState.table.length >= 6) return tg.showAlert("–ú–∞–∫—Å–∏–º—É–º 6 –∫–∞—Ä—Ç!");
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–Ω–≥–∞
            if (gameState.table.length > 0) {
                const ranks = getAllTableRanks();
                if (!ranks.includes(card.rank)) return tg.showAlert("–ù–µ–ª—å–∑—è –ø–æ–¥–∫–∏–Ω—É—Ç—å!");
            }

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–ª-–≤–∞ –∫–∞—Ä—Ç —É —Å–æ–ø–µ—Ä–Ω–∏–∫–∞
            // –ù—É–∂–Ω–æ –Ω–∞–π—Ç–∏ ID —Å–æ–ø–µ—Ä–Ω–∏–∫–∞
            const oppId = Object.keys(gameState.players).find(id => id !== myId);
            const oppHandCount = gameState.players[oppId].hand.length;
            
            // –ö–æ–ª-–≤–æ –Ω–µ–æ—Ç–±–∏—Ç—ã—Ö –∫–∞—Ä—Ç –Ω–∞ —Å—Ç–æ–ª–µ
            const unbeatCount = gameState.table.filter(p => !p.defend).length;
            if (unbeatCount + 1 > oppHandCount) return tg.showAlert("–£ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞ –º–∞–ª–æ –∫–∞—Ä—Ç!");

            // –•–æ–¥ –≤–∞–ª–∏–¥–µ–Ω -> –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ –ë–î
            playCardToTable(card, 'attack');

        } else if (isDefender) {
            // –ó–ê–©–ò–¢–ê
            // –ò—â–µ–º –ø–µ—Ä–≤—É—é –Ω–µ–æ—Ç–±–∏—Ç—É—é –∫–∞—Ä—Ç—É
            const pairIndex = gameState.table.findIndex(p => !p.defend);
            if (pairIndex === -1) return; // –í—Å–µ –æ—Ç–±–∏—Ç–æ

            const attackCard = gameState.table[pairIndex].attack;
            
            if (canBeat(card, attackCard, gameState.trumpSuit)) {
                playCardToTable(card, 'defend', pairIndex);
            } else {
                tg.showAlert("–≠—Ç–æ–π –∫–∞—Ä—Ç–æ–π –Ω–µ –ø–æ–±–∏—Ç—å!");
            }
        }
    }

    // --- –û–ë–ù–û–í–õ–ï–ù–ò–ï –ë–î ---

    async function playCardToTable(card, type, pairIndex = null) {
        const gameRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('durak_games').doc(gameId);
        
        // –£–±–∏—Ä–∞–µ–º –∫–∞—Ä—Ç—É –∏–∑ —Ä—É–∫–∏
        const newHand = gameState.players[myId].hand.filter(c => !isCardsEqual(c, card));
        const newTable = [...gameState.table];

        if (type === 'attack') {
            newTable.push({ attack: card, defend: null });
        } else {
            newTable[pairIndex].defend = card;
        }

        // –ï—Å–ª–∏ –∑–∞—â–∏—â–∞—é—â–∏–π—Å—è –æ—Ç–±–∏–ª—Å—è, –ø—Ä–æ–≤–µ—Ä—è–µ–º, –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –ª–∏ —Ö–æ–¥?
        // –ù–µ—Ç, —Ö–æ–¥ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –ë–ò–¢–û –∏–ª–∏ –í–ó–Ø–õ.
        // –ù–æ –µ—Å–ª–∏ –æ—Ç–±–∏–ª—Å—è, –∞—Ç–∞–∫—É—é—â–∏–π –º–æ–∂–µ—Ç –ø–æ–¥–∫–∏–Ω—É—Ç—å.
        // –ü–µ—Ä–µ–¥–∞—á–∞ —Ö–æ–¥–∞ "—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏" –æ—Å—Ç–∞–µ—Ç—Å—è —É –ê—Ç–∞–∫—É—é—â–µ–≥–æ (currentTurn), –ø–æ–∫–∞ –æ–Ω –Ω–µ —Å–∫–∞–∂–µ—Ç –ë–∏—Ç–æ.

        await gameRef.update({
            [`players.${myId}.hand`]: newHand,
            table: newTable
        });
        selectedCard = null;
    }

    async function actionBito() {
        const gameRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('durak_games').doc(gameId);
        
        // –û—á–∏—â–∞–µ–º —Å—Ç–æ–ª, –¥–æ–±–∏—Ä–∞–µ–º –∫–∞—Ä—Ç—ã, –º–µ–Ω—è–µ–º —Ä–æ–ª—è–º–∏
        // 1. –ö—Ç–æ –¥–æ–±–∏—Ä–∞–µ—Ç –ø–µ—Ä–≤—ã–º? –ê—Ç–∞–∫—É—é—â–∏–π (myId). –ü–æ—Ç–æ–º –ó–∞—â–∏—â–∞—é—â–∏–π—Å—è (defenderId).
        const attackerId = myId;
        const defenderId = gameState.defenderId;
        
        let deck = [...gameState.deck];
        let p1Hand = [...gameState.players[attackerId].hand];
        let p2Hand = [...gameState.players[defenderId].hand];

        // –î–æ–±–æ—Ä
        while(p1Hand.length < 6 && deck.length > 0) p1Hand.push(deck.pop());
        while(p2Hand.length < 6 && deck.length > 0) p2Hand.push(deck.pop());
        
        sortHand(p1Hand, gameState.trumpSuit);
        sortHand(p2Hand, gameState.trumpSuit);

        // –°–º–µ–Ω–∞ —Ä–æ–ª–µ–π: —Ç–µ–ø–µ—Ä—å –±—ã–≤—à–∏–π –∑–∞—â–∏—â–∞—é—â–∏–π—Å—è –∞—Ç–∞–∫—É–µ—Ç
        await gameRef.update({
            table: [],
            deck: deck,
            [`players.${attackerId}.hand`]: p1Hand,
            [`players.${defenderId}.hand`]: p2Hand,
            currentTurn: defenderId,
            defenderId: attackerId
        });
    }

    async function actionTake() {
        const gameRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('durak_games').doc(gameId);
        
        // –ó–∞—â–∏—â–∞—é—â–∏–π—Å—è (—è) –±–µ—Ä—É –≤—Å–µ –∫–∞—Ä—Ç—ã
        const cardsToTake = [];
        gameState.table.forEach(p => {
            cardsToTake.push(p.attack);
            if(p.defend) cardsToTake.push(p.defend);
        });

        let myHand = [...gameState.players[myId].hand, ...cardsToTake];
        sortHand(myHand, gameState.trumpSuit);

        // –ê—Ç–∞–∫—É—é—â–∏–π –¥–æ–±–∏—Ä–∞–µ—Ç –∫–∞—Ä—Ç—ã
        const attackerId = gameState.currentTurn; // –¢–æ—Ç –∫—Ç–æ –∞—Ç–∞–∫–æ–≤–∞–ª
        let deck = [...gameState.deck];
        let attHand = [...gameState.players[attackerId].hand];

        while(attHand.length < 6 && deck.length > 0) attHand.push(deck.pop());
        sortHand(attHand, gameState.trumpSuit);

        // –•–æ–¥ –æ—Å—Ç–∞–µ—Ç—Å—è —É –∞—Ç–∞–∫—É—é—â–µ–≥–æ (—è –ø—Ä–æ–ø—É—Å—Ç–∏–ª —Ö–æ–¥, —Ç.–∫. –≤–∑—è–ª)
        // –¢.–µ. —Ä–æ–ª–∏ –ù–ï –º–µ–Ω—è—é—Ç—Å—è.
        
        await gameRef.update({
            table: [],
            deck: deck,
            [`players.${myId}.hand`]: myHand,
            [`players.${attackerId}.hand`]: attHand
            // currentTurn –∏ defenderId –Ω–µ –º–µ–Ω—è—é—Ç—Å—è
        });
    }

    // --- –£–¢–ò–õ–ò–¢–´ ---

    function generateDeck() {
        let d = [];
        for(let s of SUITS) {
            for(let r of RANKS) {
                d.push({rank: r, suit: s});
            }
        }
        // Shuffle
        for (let i = d.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [d[i], d[j]] = [d[j], d[i]];
        }
        return d;
    }

    function sortHand(hand, trumpSuit) {
        hand.sort((a, b) => {
            const valA = VALUES[a.rank] + (a.suit === trumpSuit ? 100 : 0);
            const valB = VALUES[b.rank] + (b.suit === trumpSuit ? 100 : 0);
            return valA - valB;
        });
    }

    function isRed(suit) { return suit === '‚ô¶' || suit === '‚ô•'; }
    
    function isCardsEqual(c1, c2) { return c1.rank === c2.rank && c1.suit === c2.suit; }

    function getAllTableRanks() {
        return gameState.table.flatMap(p => [p.attack.rank, p.defend ? p.defend.rank : null]).filter(r => r);
    }

    function canBeat(card, target, trumpSuit) {
        if (card.suit === target.suit) {
            return VALUES[card.rank] > VALUES[target.rank];
        }
        return card.suit === trumpSuit;
    }

</script>
</body>
</html>
