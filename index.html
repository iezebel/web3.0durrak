<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–î—É—Ä–∞–∫: –û–Ω–ª–∞–π–Ω –∏ –û—Ñ–ª–∞–π–Ω</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@500&display=swap');
        
        body {
            background-color: #2e7d32;
            background-image: radial-gradient(#358e39 15%, transparent 16%), radial-gradient(#358e39 15%, transparent 16%);
            background-size: 60px 60px;
            font-family: 'Segoe UI', sans-serif;
            overflow: hidden;
            user-select: none;
            touch-action: manipulation;
        }

        /* --- STYLES --- */
        .card {
            width: 70px; height: 105px;
            background-color: white; border-radius: 6px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            display: flex; flex-direction: column; justify-content: space-between;
            padding: 4px; position: absolute;
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer; border: 1px solid #ccc;
        }
        .card:hover { transform: translateY(-10px); z-index: 50 !important; }
        .card.selected { border: 2px solid #3b82f6; transform: translateY(-15px); }
        .suit-red { color: #e53e3e; }
        .suit-black { color: #1a202c; }
        
        @media (min-width: 640px) {
            .card { width: 90px; height: 135px; padding: 6px; }
        }

        /* –ó–æ–Ω—ã */
        #game-table {
            position: absolute; top: 45%; left: 50%; transform: translate(-50%, -50%);
            width: 100%; max-width: 700px; height: 220px;
            display: flex; justify-content: center; align-items: center; pointer-events: none;
        }
        .table-slot { width: 80px; height: 120px; margin: 0 6px; position: relative; pointer-events: none; }

        /* –†—É–∫–∏ */
        #player-hand {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            height: 140px; width: 100%; display: flex; justify-content: center; align-items: flex-end;
        }
        .hand-card-wrapper { margin-left: -35px; position: relative; width: 70px; height: 105px; transition: margin 0.2s; }
        .hand-card-wrapper:first-child { margin-left: 0; }
        .hand-card-wrapper:hover { margin-right: 20px; }

        #opponent-hand {
            position: absolute; top: -10px; left: 50%; transform: translateX(-50%);
            display: flex; justify-content: center;
        }
        .opponent-card-back {
            width: 50px; height: 80px; margin-left: -30px;
            background: repeating-linear-gradient(45deg, #1e3a8a, #1e3a8a 5px, #2563eb 5px, #2563eb 10px);
            border: 2px solid white; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        /* UI */
        .btn-primary {
            background: #2563eb; color: white; padding: 0.75rem 1.5rem; border-radius: 9999px; font-weight: bold;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); transition: all 0.2s; cursor: pointer;
        }
        .btn-primary:active { transform: scale(0.95); }
        .btn-secondary {
            background: #dc2626; color: white; padding: 0.75rem 1.5rem; border-radius: 9999px; font-weight: bold;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); transition: all 0.2s; cursor: pointer;
        }

        #lobby-screen { z-index: 1000; background: rgba(0,0,0,0.85); backdrop-filter: blur(5px); }
    </style>
</head>
<body class="h-screen w-screen text-gray-800">

    <!-- –õ–û–ë–ë–ò -->
    <div id="lobby-screen" class="fixed inset-0 flex items-center justify-center text-white">
        <div class="bg-white text-gray-800 p-8 rounded-xl shadow-2xl max-w-md w-full mx-4 relative overflow-hidden">
            <h1 class="text-3xl font-bold mb-2 text-center text-blue-800">–î—É—Ä–∞–∫</h1>
            <p class="text-center text-gray-500 mb-6 text-sm">–ö–∞—Ä—Ç–æ—á–Ω–∞—è –∏–≥—Ä–∞</p>
            
            <div id="lobby-main" class="space-y-4">
                <!-- –û–§–õ–ê–ô–ù -->
                <button onclick="startOfflineGame()" class="w-full bg-gradient-to-r from-green-500 to-green-700 text-white font-bold py-4 rounded-lg shadow-lg hover:from-green-600 hover:to-green-800 transition transform hover:scale-105 flex items-center justify-center gap-2">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    –ò–≥—Ä–∞—Ç—å —Å –ë–æ—Ç–æ–º (–û—Ñ–ª–∞–π–Ω)
                </button>

                <div class="relative flex py-2 items-center">
                    <div class="flex-grow border-t border-gray-300"></div>
                    <span class="flex-shrink-0 mx-4 text-gray-400 text-xs uppercase">–ò–ª–∏ –û–Ω–ª–∞–π–Ω</span>
                    <div class="flex-grow border-t border-gray-300"></div>
                </div>

                <!-- –û–ù–õ–ê–ô–ù -->
                <div id="online-controls" class="space-y-3 opacity-50 pointer-events-none transition-opacity">
                    <div class="text-xs text-center text-blue-600 mb-2" id="auth-status">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É...</div>
                    <button onclick="createOnlineGame()" class="w-full btn-primary bg-blue-600 hover:bg-blue-700 text-sm py-3">
                        –°–æ–∑–¥–∞—Ç—å –û–Ω–ª–∞–π–Ω –ò–≥—Ä—É
                    </button>
                    <div class="flex gap-2">
                        <input id="join-game-id" type="text" placeholder="ID (6 —Ü–∏—Ñ—Ä)" 
                               class="flex-1 border-2 border-gray-300 p-2 rounded-lg text-center font-mono uppercase text-sm">
                        <button onclick="joinOnlineGame()" class="btn-primary py-2 text-sm">–í–æ–π—Ç–∏</button>
                    </div>
                </div>
                
                <!-- –°—Å—ã–ª–∫–∞ –Ω–∞ –≤–Ω–µ—à–Ω–∏–π —Å–∞–π—Ç -->
                <div class="pt-4 border-t border-gray-200 mt-4 text-center">
                    <p class="text-xs text-gray-400 mb-2">–ò–ª–∏ –ø–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Å–∞–π—Ç:</p>
                    <a href="https://iezebel.github.io/web3.0durrak/" target="_blank" class="inline-block bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-2 px-4 rounded-lg text-sm transition">
                        üîó –û—Ç–∫—Ä—ã—Ç—å iezebel.github.io
                    </a>
                </div>
            </div>

            <!-- –≠–∫—Ä–∞–Ω –æ–∂–∏–¥–∞–Ω–∏—è (–æ–Ω–ª–∞–π–Ω) -->
            <div id="waiting-room" class="hidden text-center">
                <h2 class="text-xl font-bold mb-2">–û–∂–∏–¥–∞–Ω–∏–µ –∏–≥—Ä–æ–∫–∞</h2>
                <div class="bg-yellow-100 p-4 rounded-lg mb-4 border-2 border-yellow-300">
                    <div class="text-sm text-gray-600">–ö–æ–¥ –∫–æ–º–Ω–∞—Ç—ã:</div>
                    <div id="display-game-id" class="text-4xl font-mono font-bold tracking-widest text-blue-700 select-all cursor-pointer" onclick="copyId()">------</div>
                </div>
                <button onclick="leaveGame()" class="text-red-500 hover:underline text-sm">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>

    <!-- –ò–ì–†–û–í–û–ô –ò–ù–¢–ï–†–§–ï–ô–° -->
    <div id="game-ui" class="hidden h-full w-full relative">
        <!-- –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å -->
        <div class="absolute top-0 left-0 w-full p-2 flex justify-between items-start z-10 pointer-events-none">
            <div id="status-badge" class="bg-gray-700 text-white px-4 py-2 rounded-full text-sm font-bold shadow-lg backdrop-blur-md pointer-events-auto transition-colors">
                –û–∂–∏–¥–∞–Ω–∏–µ...
            </div>
            <div class="text-right pointer-events-auto flex flex-col items-end gap-2">
                <div class="bg-white/90 text-gray-900 px-3 py-1 rounded shadow text-sm font-bold flex items-center gap-2">
                    –ö–æ–∑—ã—Ä—å: <span id="trump-suit-display" class="text-xl leading-none"></span>
                </div>
                <button onclick="leaveGame()" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-xs shadow">–ú–µ–Ω—é</button>
            </div>
        </div>

        <!-- –°—Ç–æ–ª -->
        <div id="opponent-hand"></div>
        <div id="opponent-name" class="absolute top-16 left-1/2 transform -translate-x-1/2 text-white/70 text-sm font-bold bg-black/20 px-2 rounded">–°–æ–ø–µ—Ä–Ω–∏–∫</div>

        <div id="deck-area" class="absolute left-4 top-1/2 transform -translate-y-1/2">
            <div class="relative w-[70px] h-[105px]">
                <div id="trump-card-el" class="absolute top-0 left-0 transition-all"></div>
                <div id="deck-stack" class="absolute top-0 left-0 w-full h-full bg-blue-900 border-2 border-white rounded-lg shadow-lg flex items-center justify-center">
                    <span id="deck-count" class="text-white font-bold text-xl">36</span>
                </div>
            </div>
        </div>

        <div id="game-table"></div>

        <div id="action-area" class="absolute bottom-44 left-1/2 transform -translate-x-1/2 z-50 transition-opacity opacity-0 pointer-events-none">
            <button id="main-action-btn" class="btn-primary pointer-events-auto shadow-2xl ring-4 ring-white/30 text-lg px-8 py-3">–î–µ–π—Å—Ç–≤–∏–µ</button>
        </div>

        <div id="player-hand"></div>

        <!-- –¢–æ—Å—Ç—ã -->
        <div id="toast" class="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-black/80 text-white px-6 py-3 rounded-xl pointer-events-none transition-all opacity-0 scale-90 z-[200]">
            –°–æ–æ–±—â–µ–Ω–∏–µ
        </div>
    </div>

    <!-- –õ–û–ì–ò–ö–ê -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, updateDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL STATE ---
        let GAME_MODE = 'OFFLINE'; // 'ONLINE' or 'OFFLINE'
        let currentUser = { uid: 'player-offline' };
        let currentGameId = null;
        let unsubscribeGame = null;
        
        let localState = null; // –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã
        let botTimer = null;

        // --- FIREBASE INIT (Try-Catch for Safety) ---
        let db, auth, gamesRef;
        let isFirebaseReady = false;

        try {
            // –ü—ã—Ç–∞–µ–º—Å—è –≤–∑—è—Ç—å –∫–æ–Ω—Ñ–∏–≥ —Å—Ä–µ–¥—ã
            const fbConfig = (typeof __firebase_config !== 'undefined') 
                ? JSON.parse(__firebase_config) 
                : { apiKey: "AIzaSyBlfCYqHw_uHxP6pyKOkW0QFsuHFw9_XyY" }; // Fallback (–Ω–µ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è Firestore –±–µ–∑ projectId)

            if (fbConfig.projectId) {
                const app = initializeApp(fbConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default';
                gamesRef = collection(db, 'artifacts', appId, 'public', 'data', 'games');
                
                // Auth
                const initAuth = async () => {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                };
                initAuth();

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentUser = user;
                        isFirebaseReady = true;
                        document.getElementById('online-controls').classList.remove('opacity-50', 'pointer-events-none');
                        document.getElementById('auth-status').innerText = "–°–µ—Ä–≤–µ—Ä –ø–æ–¥–∫–ª—é—á–µ–Ω";
                        document.getElementById('auth-status').className = "text-xs text-center text-green-600 mb-2";
                    }
                });
            } else {
                document.getElementById('auth-status').innerText = "–û–Ω–ª–∞–π–Ω –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (–ù–µ—Ç –∫–æ–Ω—Ñ–∏–≥–∞)";
                document.getElementById('auth-status').className = "text-xs text-center text-red-500 mb-2";
            }
        } catch (e) {
            console.log("Firebase init error (Offline mode only):", e);
        }

        // --- LOBBY FUNCTIONS ---

        window.startOfflineGame = () => {
            GAME_MODE = 'OFFLINE';
            currentUser = { uid: 'player' };
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            const deck = createDeck();
            const trump = deck[0];
            const pHand = [];
            const bHand = [];
            
            for(let i=0; i<6; i++) { pHand.push(deck.pop()); bHand.push(deck.pop()); }

            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–µ—Ä–≤—ã–π —Ö–æ–¥
            let pMin = 100, bMin = 100;
            pHand.forEach(c => { if(c.suit === trump.suit && c.value < pMin) pMin = c.value; });
            bHand.forEach(c => { if(c.suit === trump.suit && c.value < bMin) bMin = c.value; });
            const playerFirst = pMin < bMin; // –ï—Å–ª–∏ —É –±–æ—Ç–∞ –Ω–µ—Ç –∫–æ–∑—ã—Ä—è (100), –∞ —É –∏–≥—Ä–æ–∫–∞ —Ç–æ–∂–µ (100) -> false (–±–æ—Ç)

            localState = {
                status: 'playing',
                deck: deck,
                trumpCard: trump,
                trumpSuit: trump.suit,
                hands: { 'player': pHand, 'bot': bHand },
                table: [],
                turn: playerFirst ? 'player' : 'bot',
                attacker: playerFirst ? 'player' : 'bot',
                hostId: 'player',
                joinerId: 'bot'
            };

            showGameUI();
            renderGame(localState);
            
            if (localState.turn === 'bot') setTimeout(botTurn, 1000);
        };

        window.createOnlineGame = async () => {
            if (!isFirebaseReady) return showToast("–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É");
            GAME_MODE = 'ONLINE';
            const gameId = Math.floor(100000 + Math.random() * 900000).toString();
            const deck = createDeck();
            
            const state = {
                hostId: currentUser.uid,
                joinerId: null,
                status: 'waiting',
                deck: deck,
                trumpCard: deck[0],
                trumpSuit: deck[0].suit,
                hands: { [currentUser.uid]: [] },
                table: [],
                turn: currentUser.uid,
                attacker: currentUser.uid,
                lastUpdate: serverTimestamp()
            };

            await setDoc(doc(gamesRef, gameId), state);
            currentGameId = gameId;
            document.getElementById('lobby-main').classList.add('hidden');
            document.getElementById('waiting-room').classList.remove('hidden');
            document.getElementById('display-game-id').innerText = gameId;
            subscribeToGame(gameId);
        };

        window.joinOnlineGame = async () => {
            if (!isFirebaseReady) return showToast("–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è");
            const inputId = document.getElementById('join-game-id').value.trim();
            if (inputId.length !== 6) return showToast("–ù—É–∂–µ–Ω ID –∏–∑ 6 —Ü–∏—Ñ—Ä");
            GAME_MODE = 'ONLINE';

            const gameRef = doc(gamesRef, inputId);
            const snap = await getDoc(gameRef);
            if (!snap.exists()) return showToast("–ò–≥—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");
            const data = snap.data();
            if (data.status !== 'waiting') return showToast("–ò–≥—Ä–∞ –∑–∞–Ω—è—Ç–∞");

            // Deal logic
            const deck = [...data.deck];
            const h1 = [], h2 = [];
            for(let i=0; i<6; i++) { if(deck.length) h1.push(deck.pop()); if(deck.length) h2.push(deck.pop()); }

            await updateDoc(gameRef, {
                joinerId: currentUser.uid,
                status: 'playing',
                deck: deck,
                [`hands.${data.hostId}`]: h1,
                [`hands.${currentUser.uid}`]: h2,
                attacker: data.hostId, // –•–æ—Å—Ç —Ö–æ–¥–∏—Ç –ø–µ—Ä–≤—ã–º —É–ø—Ä–æ—â–µ–Ω–Ω–æ
                turn: data.hostId
            });

            currentGameId = inputId;
            subscribeToGame(inputId);
        };

        function subscribeToGame(id) {
            unsubscribeGame = onSnapshot(doc(gamesRef, id), (snap) => {
                if(!snap.exists()) return leaveGame();
                const d = snap.data();
                localState = d;
                if (d.status === 'playing') {
                    showGameUI();
                    renderGame(d);
                }
            });
        }

        // --- CORE GAME RENDER & LOGIC ---

        function renderGame(state) {
            const myUid = GAME_MODE === 'OFFLINE' ? 'player' : currentUser.uid;
            const oppUid = GAME_MODE === 'OFFLINE' ? 'bot' : (state.hostId === myUid ? state.joinerId : state.hostId);

            // 1. Status Bar
            const isMyTurn = state.turn === myUid;
            const amIAttacker = state.attacker === myUid;
            const badge = document.getElementById('status-badge');
            
            if (isMyTurn) {
                badge.innerText = amIAttacker ? "–í–∞—à —Ö–æ–¥: –ê—Ç–∞–∫—É–π—Ç–µ" : "–í–∞—à —Ö–æ–¥: –û—Ç–±–∏–≤–∞–π—Ç–µ—Å—å";
                badge.className = "px-4 py-2 rounded-full text-sm font-bold shadow-lg transition-colors bg-green-600 text-white animate-pulse";
            } else {
                badge.innerText = "–•–æ–¥ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞...";
                badge.className = "px-4 py-2 rounded-full text-sm font-bold shadow-lg transition-colors bg-gray-700 text-white";
            }

            // 2. Info
            const trump = state.trumpCard;
            const suitHtml = `<span class="${(trump.suit === 'hearts' || trump.suit === 'diamonds') ? 'text-red-500' : 'text-gray-900'}">${getSuitChar(trump.suit)}</span>`;
            document.getElementById('trump-suit-display').innerHTML = suitHtml;
            document.getElementById('deck-count').innerText = state.deck.length;

            const trumpEl = document.getElementById('trump-card-el');
            trumpEl.innerHTML = renderCardHTML(trump);
            trumpEl.style.transform = 'rotate(90deg) translateX(30px)';
            if (state.deck.length === 0) {
                document.getElementById('deck-stack').classList.add('hidden');
                trumpEl.style.opacity = '0.5';
            } else {
                document.getElementById('deck-stack').classList.remove('hidden');
                trumpEl.style.opacity = '1';
            }

            // 3. Table
            const tableEl = document.getElementById('game-table');
            tableEl.innerHTML = '';
            state.table.forEach(pair => {
                const slot = document.createElement('div');
                slot.className = 'table-slot';
                
                const att = document.createElement('div');
                att.className = 'card';
                att.innerHTML = renderCardHTML(pair.attack);
                slot.appendChild(att);

                if(pair.defend) {
                    const def = document.createElement('div');
                    def.className = 'card';
                    def.style.top = '20px'; def.style.left = '20px'; def.style.zIndex = 10;
                    def.innerHTML = renderCardHTML(pair.defend);
                    slot.appendChild(def);
                }
                tableEl.appendChild(slot);
            });

            // 4. My Hand
            const handEl = document.getElementById('player-hand');
            handEl.innerHTML = '';
            const myHand = state.hands[myUid] || [];
            
            // Sort
            myHand.sort((a,b) => {
                const trA = a.suit === state.trumpSuit;
                const trB = b.suit === state.trumpSuit;
                if(trA && !trB) return 1;
                if(!trA && trB) return -1;
                if(a.suit === b.suit) return a.value - b.value;
                return a.suit.localeCompare(b.suit);
            });

            myHand.forEach(card => {
                const wrap = document.createElement('div');
                wrap.className = 'hand-card-wrapper';
                const cDiv = document.createElement('div');
                cDiv.className = 'card hover:ring-2 ring-blue-400';
                cDiv.innerHTML = renderCardHTML(card);
                cDiv.onclick = () => playerCardClick(card);
                wrap.appendChild(cDiv);
                handEl.appendChild(wrap);
            });

            // 5. Opponent Hand
            const oppHandEl = document.getElementById('opponent-hand');
            oppHandEl.innerHTML = '';
            const oppCount = (state.hands[oppUid] || []).length;
            for(let i=0; i<oppCount; i++) {
                const back = document.createElement('div');
                back.className = 'opponent-card-back';
                oppHandEl.appendChild(back);
            }

            // 6. Buttons
            const btnArea = document.getElementById('action-area');
            const btn = document.getElementById('main-action-btn');
            
            if (state.table.length === 0) {
                btnArea.classList.add('opacity-0', 'pointer-events-none');
            } else if (isMyTurn) {
                btnArea.classList.remove('opacity-0', 'pointer-events-none');
                if (amIAttacker) {
                    // Attack phase
                    const allDefended = state.table.every(p => p.defend);
                    if (allDefended) {
                        btn.innerText = "–ë–∏—Ç–æ";
                        btn.className = "btn-primary bg-green-600 hover:bg-green-700 text-lg px-8 py-3 shadow-green-500/50";
                        btn.onclick = () => performAction('bito');
                    } else {
                        btnArea.classList.add('opacity-0', 'pointer-events-none'); // Wait for defender
                    }
                } else {
                    // Defend phase
                    btn.innerText = "–í–∑—è—Ç—å";
                    btn.className = "btn-secondary bg-red-600 hover:bg-red-700 text-lg px-8 py-3 shadow-red-500/50";
                    btn.onclick = () => performAction('take');
                }
            } else {
                btnArea.classList.add('opacity-0', 'pointer-events-none');
            }
        }

        // --- ACTIONS ---

        window.playerCardClick = (card) => {
            const state = localState;
            const myUid = GAME_MODE === 'OFFLINE' ? 'player' : currentUser.uid;
            
            if (state.turn !== myUid) return showToast("–ù–µ –≤–∞—à —Ö–æ–¥!");

            const amIAttacker = state.attacker === myUid;
            
            if (amIAttacker) {
                // Check if valid attack (match existing ranks)
                if (state.table.length > 0) {
                    const validRanks = new Set();
                    state.table.forEach(p => { validRanks.add(p.attack.rank); if(p.defend) validRanks.add(p.defend.rank); });
                    if (!validRanks.has(card.rank)) return showToast("–ö–∞—Ä—Ç–∞ –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç (—Ä–∞–Ω–≥)");
                }
                if (state.table.length >= 6) return showToast("–°—Ç–æ–ª –ø–æ–ª–æ–Ω");
                
                applyMove(card, 'attack');
            } else {
                // Defend
                const pairIdx = state.table.findIndex(p => !p.defend);
                if (pairIdx === -1) return; // All defended
                
                const att = state.table[pairIdx].attack;
                let beats = false;
                if (card.suit === att.suit && card.value > att.value) beats = true;
                else if (card.suit === state.trumpSuit && att.suit !== state.trumpSuit) beats = true;
                
                if (!beats) return showToast("–≠—Ç–æ–π –∫–∞—Ä—Ç–æ–π –Ω–µ–ª—å–∑—è –ø–æ–±–∏—Ç—å");
                
                applyMove(card, 'defend', pairIdx);
            }
        };

        window.performAction = (type) => {
            if (GAME_MODE === 'OFFLINE') {
                processOfflineAction(type);
            } else {
                processOnlineAction(type);
            }
        };

        async function applyMove(card, type, idx = -1) {
            const myUid = GAME_MODE === 'OFFLINE' ? 'player' : currentUser.uid;
            
            // –û–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –∏–∑ —Ä—É–∫–∏
            localState.hands[myUid] = localState.hands[myUid].filter(c => !(c.rank===card.rank && c.suit===card.suit));
            
            if (type === 'attack') {
                localState.table.push({ attack: card, defend: null });
                // –°–º–µ–Ω–∞ —Ö–æ–¥–∞: –µ—Å–ª–∏ –∞—Ç–∞–∫–æ–≤–∞–ª, —Ö–æ–¥ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –∑–∞—â–∏—Ç–Ω–∏–∫—É
                const oppId = GAME_MODE==='OFFLINE' ? 'bot' : (localState.hostId===myUid ? localState.joinerId : localState.hostId);
                localState.turn = oppId;
            } else {
                localState.table[idx].defend = card;
                // –°–º–µ–Ω–∞ —Ö–æ–¥–∞: –µ—Å–ª–∏ –æ—Ç–±–∏–ª—Å—è, —Ö–æ–¥ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –∞—Ç–∞–∫—É—é—â–µ–º—É (–º–æ–∂–µ—Ç –ø–æ–¥–∫–∏–Ω—É—Ç—å)
                localState.turn = localState.attacker;
            }

            renderGame(localState);

            if (GAME_MODE === 'ONLINE') {
                await updateDoc(doc(gamesRef, currentGameId), {
                    [`hands.${myUid}`]: localState.hands[myUid],
                    table: localState.table,
                    turn: localState.turn
                });
            } else {
                if (localState.turn === 'bot') setTimeout(botTurn, 1000);
            }
        }

        // --- OFFLINE / BOT LOGIC ---

        function processOfflineAction(action) {
            const state = localState;
            const oppId = 'bot';
            const myId = 'player';
            
            if (action === 'bito') {
                drawCards(myId, oppId);
                state.table = [];
                state.attacker = oppId; 
                state.turn = oppId;
                renderGame(state);
                setTimeout(botTurn, 1000);
            } else if (action === 'take') {
                takeCards(myId); // –ò–≥—Ä–æ–∫ –±–µ—Ä–µ—Ç
                drawCards(oppId); // –ë–æ—Ç –¥–æ–±–∏—Ä–∞–µ—Ç
                state.table = [];
                state.attacker = oppId; // –ë–æ—Ç —Å–Ω–æ–≤–∞ –∞—Ç–∞–∫—É–µ—Ç
                state.turn = oppId;
                renderGame(state);
                setTimeout(botTurn, 1000);
            }
        }

        function botTurn() {
            if (!localState || GAME_MODE !== 'OFFLINE') return;
            const state = localState;
            const botHand = state.hands['bot'];
            const amIAttacker = state.attacker === 'bot';

            if (amIAttacker) {
                // –ê–¢–ê–ö–ê –ë–û–¢–ê
                if (state.table.length === 0) {
                    // –ö–∏–¥–∞–µ–º —Å–∞–º—É—é –º–µ–ª–∫—É—é
                    const c = getLowestCard(botHand, state.trumpSuit);
                    botApplyMove(c, 'attack');
                } else {
                    // –ü–æ–¥–∫–∏–¥—ã–≤–∞–µ–º
                    const ranks = new Set();
                    state.table.forEach(p => { ranks.add(p.attack.rank); if(p.defend) ranks.add(p.defend.rank); });
                    const options = botHand.filter(c => ranks.has(c.rank));
                    
                    if (options.length > 0) {
                        options.sort((a,b) => a.value - b.value);
                        botApplyMove(options[0], 'attack');
                    } else {
                        // –ë–∏—Ç–æ
                        botDoAction('bito');
                    }
                }
            } else {
                // –ó–ê–©–ò–¢–ê –ë–û–¢–ê
                const pairIdx = state.table.findIndex(p => !p.defend);
                if (pairIdx === -1) return; // –ñ–¥–µ–º –∞—Ç–∞–∫—É—é—â–µ–≥–æ
                
                const att = state.table[pairIdx].attack;
                // –ò—â–µ–º —á–µ–º –ø–æ–±–∏—Ç—å
                let beaters = botHand.filter(c => {
                    if (c.suit === att.suit) return c.value > att.value;
                    if (c.suit === state.trumpSuit && att.suit !== state.trumpSuit) return true;
                    return false;
                });

                if (beaters.length > 0) {
                    // –ë—å–µ–º —Å–∞–º–æ–π –¥–µ—à–µ–≤–æ–π
                    beaters.sort((a,b) => {
                        const trA = a.suit === state.trumpSuit ? 1 : 0;
                        const trB = b.suit === state.trumpSuit ? 1 : 0;
                        if (trA !== trB) return trA - trB;
                        return a.value - b.value;
                    });
                    botApplyMove(beaters[0], 'defend', pairIdx);
                } else {
                    botDoAction('take');
                }
            }
        }

        function botApplyMove(card, type, idx) {
            const state = localState;
            state.hands['bot'] = state.hands['bot'].filter(c => c !== card);
            
            if (type === 'attack') {
                state.table.push({ attack: card, defend: null });
                state.turn = 'player';
            } else {
                state.table[idx].defend = card;
                state.turn = 'bot'; // –í–µ—Ä–Ω—É–ª–∏ —Ö–æ–¥ –∞—Ç–∞–∫—É—é—â–µ–º—É –±–æ—Ç—É
            }
            renderGame(state);
            // –ï—Å–ª–∏ –±–æ—Ç –æ—Ç–±–∏–ª—Å—è, –æ–Ω —Ç—É—Ç –∂–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –º–æ–∂–µ—Ç –ª–∏ –ø–æ–¥–∫–∏–Ω—É—Ç—å (—á–µ—Ä–µ–∑ –∑–∞–¥–µ—Ä–∂–∫—É)
            if (type === 'defend') setTimeout(botTurn, 1000);
        }

        function botDoAction(action) {
            const state = localState;
            if (action === 'bito') {
                showToast("–ë–æ—Ç: –ë–∏—Ç–æ!");
                drawCards('bot', 'player');
                state.table = [];
                state.attacker = 'player';
                state.turn = 'player';
                renderGame(state);
            } else if (action === 'take') {
                showToast("–ë–æ—Ç –±–µ—Ä–µ—Ç –∫–∞—Ä—Ç—ã");
                takeCards('bot');
                drawCards('player');
                state.table = [];
                state.attacker = 'player';
                state.turn = 'player';
                renderGame(state);
            }
        }

        // --- ONLINE ACTIONS ---
        async function processOnlineAction(action) {
            const myUid = currentUser.uid;
            const oppUid = localState.hostId === myUid ? localState.joinerId : localState.hostId;
            const ref = doc(gamesRef, currentGameId);
            
            if (action === 'bito') {
                // –õ–æ–∫–∞–ª—å–Ω–æ —Å—á–∏—Ç–∞–µ–º –ª–æ–≥–∏–∫—É –¥–æ–±–æ—Ä–∞
                let d = [...localState.deck];
                let h = { ...localState.hands };
                const uids = [localState.attacker, (localState.attacker===myUid?oppUid:myUid)]; // –°–Ω–∞—á–∞–ª–∞ –∞—Ç–∞–∫—É—é—â–∏–π
                
                uids.forEach(uid => {
                    while(h[uid].length < 6 && d.length > 0) h[uid].push(d.pop());
                });

                await updateDoc(ref, {
                    table: [], deck: d, hands: h,
                    attacker: oppUid, turn: oppUid
                });

            } else if (action === 'take') {
                let d = [...localState.deck];
                let h = { ...localState.hands };
                let cards = [];
                localState.table.forEach(p => { cards.push(p.attack); if(p.defend) cards.push(p.defend); });
                
                h[myUid] = [...h[myUid], ...cards]; // –¢–æ—Ç –∫—Ç–æ –Ω–∞–∂–∞–ª –≤–∑—è—Ç—å
                while(h[oppUid].length < 6 && d.length > 0) h[oppUid].push(d.pop()); // –ê—Ç–∞–∫—É—é—â–∏–π –¥–æ–±–∏—Ä–∞–µ—Ç

                await updateDoc(ref, {
                    table: [], deck: d, hands: h,
                    attacker: oppUid, turn: oppUid
                });
            }
        }

        // --- UTILS ---
        
        function drawCards(attId, defId) { // –¥–ª—è –æ—Ñ–ª–∞–π–Ω–∞
            const state = localState;
            // –ü–æ—Ä—è–¥–æ–∫: –°–Ω–∞—á–∞–ª–∞ –∞—Ç–∞–∫—É—é—â–∏–π, –ø–æ—Ç–æ–º –∑–∞—â–∏—Ç–Ω–∏–∫ (—É–ø—Ä–æ—â–µ–Ω–Ω–æ)
            [attId, defId].forEach(id => {
                if (!id) return;
                while(state.hands[id].length < 6 && state.deck.length > 0) state.hands[id].push(state.deck.pop());
            });
        }

        function takeCards(takerId) {
            const state = localState;
            state.table.forEach(p => {
                state.hands[takerId].push(p.attack);
                if(p.defend) state.hands[takerId].push(p.defend);
            });
        }

        function getLowestCard(hand, trumpSuit) {
            return hand.reduce((p, c) => {
                const trP = p.suit===trumpSuit?1:0;
                const trC = c.suit===trumpSuit?1:0;
                if(trP !== trC) return trP < trC ? p : c;
                return p.value < c.value ? p : c;
            });
        }

        function createDeck() {
            const suits = ['hearts', 'diamonds', 'clubs', 'spades'];
            const ranks = ['6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A'];
            const values = { '6': 6, '7': 7, '8': 8, '9': 9, '10': 10, 'J': 11, 'Q': 12, 'K': 13, 'A': 14 };
            let d = [];
            for (let s of suits) for (let r of ranks) d.push({ suit: s, rank: r, value: values[r] });
            for (let i = d.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [d[i], d[j]] = [d[j], d[i]]; }
            return d;
        }

        function renderCardHTML(card) {
            const color = (card.suit === 'hearts' || card.suit === 'diamonds') ? 'suit-red' : 'suit-black';
            return `<div class="text-left font-bold text-sm leading-none ${color}">${card.rank}</div>
                    <div class="flex-grow flex items-center justify-center text-3xl ${color}">${getSuitChar(card.suit)}</div>
                    <div class="text-right font-bold text-sm leading-none transform rotate-180 ${color}">${card.rank}</div>`;
        }
        function getSuitChar(s) { return { 'hearts': '‚ô•', 'diamonds': '‚ô¶', 'clubs': '‚ô£', 'spades': '‚ô†' }[s]; }

        window.showGameUI = () => {
            document.getElementById('lobby-screen').classList.add('hidden');
            document.getElementById('game-ui').classList.remove('hidden');
        };
        window.leaveGame = () => {
            if (unsubscribeGame) unsubscribeGame();
            document.getElementById('game-ui').classList.add('hidden');
            document.getElementById('lobby-screen').classList.remove('hidden');
            document.getElementById('lobby-main').classList.remove('hidden');
            document.getElementById('waiting-room').classList.add('hidden');
            localState = null;
        };
        window.copyId = () => { navigator.clipboard.writeText(currentGameId); showToast("ID –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω"); }
        window.showToast = (m) => {
            const t = document.getElementById('toast');
            t.innerText = m; t.classList.remove('opacity-0', 'scale-90');
            setTimeout(() => t.classList.add('opacity-0', 'scale-90'), 2000);
        };
    </script>
</body>
</html>
