<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Дурак: Ultimate Green (Stable)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@500&family=Russo+One&display=swap');
        
        body {
            background-color: #2e7d32;
            background-image: radial-gradient(#358e39 15%, transparent 16%), radial-gradient(#358e39 15%, transparent 16%);
            background-size: 60px 60px;
            font-family: 'Segoe UI', sans-serif;
            overflow: hidden;
            user-select: none;
            touch-action: manipulation;
            color: #1a202c;
            -webkit-tap-highlight-color: transparent;
        }

        /* --- КАРТЫ --- */
        .card {
            width: 70px; height: 105px;
            background-color: white; border-radius: 6px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            display: flex; flex-direction: column; justify-content: space-between;
            padding: 4px; position: absolute;
            transition: transform 0.2s, box-shadow 0.2s, top 0.2s, left 0.2s;
            cursor: pointer; border: 1px solid #ccc;
            flex-shrink: 0;
            z-index: 10;
        }
        .card:hover { transform: translateY(-15px); z-index: 100 !important; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .suit-red { color: #e53e3e; }
        .suit-black { color: #1a202c; }
        .card-joker { background: linear-gradient(135deg, #7e22ce, #a855f7); color: white; border: 2px solid #facc15; }

        @media (min-width: 640px) { .card { width: 90px; height: 135px; padding: 6px; } }

        /* --- ЗОНЫ --- */
        #game-table {
            position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%);
            width: 100%; max-width: 800px; height: 240px;
            display: flex; justify-content: center; align-items: center; pointer-events: none;
            z-index: 10;
            flex-wrap: wrap;
        }
        .table-slot { width: 80px; height: 120px; margin: 2px 4px; position: relative; pointer-events: none; }

        /* Фантом */
        .phantom-card {
            position: absolute; top: 0; right: -85px; 
            width: 70px; height: 105px;
            border: 3px dashed #60a5fa; background: rgba(37, 99, 235, 0.4); border-radius: 6px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            color: white; cursor: pointer; pointer-events: auto;
            animation: pulse-blue 1.5s infinite; backdrop-filter: blur(2px); z-index: 50; text-align: center;
        }
        .phantom-card:hover { background: rgba(37, 99, 235, 0.6); transform: scale(1.05); }

        /* UI Элементы */
        .beat-target { box-shadow: 0 0 0 4px #ef4444 !important; cursor: pointer !important; pointer-events: auto !important; animation: pulse-red 1.5s infinite; z-index: 40 !important; }
        .card-selected-action { transform: translateY(-40px) scale(1.1) !important; box-shadow: 0 0 20px #facc15 !important; border: 3px solid #facc15 !important; z-index: 999 !important; }
        .card-swapping { border: 3px solid #facc15 !important; transform: translateY(-30px) !important; z-index: 50; }

        @keyframes pulse-blue { 0% { box-shadow: 0 0 0 0 rgba(96, 165, 250, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(96, 165, 250, 0); } 100% { box-shadow: 0 0 0 0 rgba(96, 165, 250, 0); } }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        @keyframes pulse-shield { 0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); } 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); } }
        .shield-active { animation: pulse-shield 2s infinite; border: 2px solid #60a5fa !important; }

        /* Скролл руки */
        #player-hand-container {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 160px;
            display: flex; justify-content: center; z-index: 20;
            overflow-x: auto; padding-bottom: 20px;
            scroll-behavior: smooth; -ms-overflow-style: none; scrollbar-width: none;
        }
        #player-hand-container::-webkit-scrollbar { display: none; }
        #player-hand { display: flex; align-items: flex-end; padding: 0 20px; min-width: min-content; }
        .hand-card-wrapper { position: relative; width: 70px; height: 105px; margin-left: -35px; transition: margin 0.2s, transform 0.2s; flex-shrink: 0; }
        .hand-card-wrapper:first-child { margin-left: 0; }
        @media (hover: hover) { .hand-card-wrapper:hover { margin-right: 30px; transform: translateY(-20px); } }

        #opponent-hand { position: absolute; top: -10px; left: 50%; transform: translateX(-50%); display: flex; justify-content: center; }
        .opponent-card-back {
            width: 50px; height: 80px; margin-left: -30px;
            background: repeating-linear-gradient(45deg, #1e3a8a, #1e3a8a 5px, #2563eb 5px, #2563eb 10px);
            border: 2px solid white; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.3); transition: all 0.3s;
        }
        .opponent-card-revealed { background: white !important; transform: translateY(10px) scale(1.1); z-index: 50; }

        /* Кнопки */
        .btn-action {
            padding: 1rem 3rem; border-radius: 999px; font-weight: 800; font-size: 1.2rem;
            box-shadow: 0 10px 15px rgba(0,0,0,0.3); transition: all 0.1s; cursor: pointer;
            border: 2px solid rgba(255,255,255,0.4); text-transform: uppercase; letter-spacing: 1px;
            pointer-events: auto; transform: scale(1);
        }
        .btn-action:active { transform: scale(0.95); box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .btn-bito { background: linear-gradient(to bottom, #22c55e, #16a34a); color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.5); } 
        .btn-take { background: linear-gradient(to bottom, #ef4444, #dc2626); color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.5); }

        .magic-btn {
            width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 1rem; box-shadow: 0 2px 4px rgba(0,0,0,0.3); transition: all 0.2s; cursor: pointer;
            position: relative; border: 2px solid rgba(255,255,255,0.5); color: white;
        }
        .magic-btn:hover { transform: scale(1.1); }
        .magic-btn:disabled { opacity: 0.5; filter: grayscale(100%); cursor: not-allowed; transform: none; }
        .magic-tooltip { position: absolute; right: 45px; font-size: 0.6rem; white-space: nowrap; font-weight: bold; background: rgba(0,0,0,0.7); padding: 2px 6px; rounded; pointer-events: none; }

        .option-btn { flex: 1; padding: 0.5rem; font-size: 0.8rem; font-weight: 700; border-radius: 0.5rem; transition: all 0.2s; border: 1px solid #d1d5db; }
        .option-btn.active { background-color: #2563eb; color: white; border-color: #2563eb; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .option-btn:not(.active) { background-color: white; color: #4b5563; hover:bg-gray-100; }

        #lobby-screen { z-index: 1000; background: rgba(0,0,0,0.85); backdrop-filter: blur(5px); }
        #game-over-screen { z-index: 2000; background: rgba(0,0,0,0.9); backdrop-filter: blur(8px); }
        #error-modal { z-index: 3000; background: rgba(0,0,0,0.9); backdrop-filter: blur(4px); }
        #effect-overlay { z-index: 1500; }

        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #888; border-radius: 2px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #555; }
    </style>
</head>
<body class="h-screen w-screen text-gray-800 select-none" onclick="globalClick(event)">

    <!-- ERROR MODAL -->
    <div id="error-modal" class="fixed inset-0 flex items-center justify-center hidden">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm text-center mx-4">
            <div class="text-red-500 text-4xl mb-2"><i class="fas fa-exclamation-circle"></i></div>
            <h3 class="text-xl font-bold mb-2 text-gray-800">Ошибка</h3>
            <p id="error-text" class="text-sm text-gray-600 mb-4">Ошибка подключения.</p>
            <button onclick="closeErrorModal()" class="bg-gray-200 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-300">ОК</button>
        </div>
    </div>

    <!-- GAME OVER -->
    <div id="game-over-screen" class="fixed inset-0 flex items-center justify-center text-white hidden opacity-0 transition-opacity duration-500">
        <div class="text-center p-8 max-w-lg w-full transform scale-90 transition-transform duration-500" id="game-over-content">
            <h1 id="go-title" class="text-6xl font-black mb-4 text-red-500 drop-shadow-[0_5px_5px_rgba(0,0,0,0.5)]">ВЫ ПРОИГРАЛИ!</h1>
            <div id="go-message" class="text-xl text-gray-200 mb-8 italic font-serif">"..."</div>
            <button onclick="leaveGame()" class="bg-white text-gray-900 font-bold py-4 px-10 rounded-full hover:bg-gray-200 hover:scale-105 transition shadow-2xl text-xl">В меню</button>
        </div>
    </div>

    <!-- ЛОББИ -->
    <div id="lobby-screen" class="fixed inset-0 flex items-center justify-center text-white p-4">
        <!-- Контейнер для двух колонок -->
        <div class="flex flex-col md:flex-row gap-6 w-full max-w-5xl justify-center items-start h-full md:h-auto overflow-y-auto md:overflow-visible">
            
            <!-- ЛЕВАЯ КОЛОНКА: МЕНЮ -->
            <div class="bg-white text-gray-800 p-6 rounded-2xl shadow-2xl w-full md:w-[400px] relative shrink-0">
                <h1 class="text-3xl font-bold mb-2 text-center text-blue-800 font-['Russo_One']">Дурак</h1>
                <p class="text-center text-gray-500 mb-6 text-sm uppercase tracking-widest font-bold">Ultimate Green</p>

                <div id="lobby-main" class="space-y-4">
                    <!-- Режим -->
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Режим игры</label>
                        <div class="flex gap-2 bg-gray-100 p-1 rounded-lg">
                            <button onclick="setMode('classic')" id="opt-mode-classic" class="option-btn active">Подкидной</button>
                            <button onclick="setMode('transfer')" id="opt-mode-transfer" class="option-btn">Переводной</button>
                        </div>
                    </div>
                    <!-- Колода -->
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Размер колоды</label>
                        <div class="flex gap-2 bg-gray-100 p-1 rounded-lg">
                            <button onclick="setDeck(24)" id="opt-deck-24" class="option-btn">24</button>
                            <button onclick="setDeck(36)" id="opt-deck-36" class="option-btn active">36</button>
                            <button onclick="setDeck(52)" id="opt-deck-52" class="option-btn">52</button>
                        </div>
                    </div>
                    <!-- Магия -->
                    <div class="flex items-center justify-between bg-blue-50 p-3 rounded-lg border border-blue-100 cursor-pointer hover:bg-blue-100 transition" onclick="toggleMagic()">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-purple-600 flex items-center justify-center text-white shadow"><i class="fas fa-hat-wizard"></i></div>
                            <div>
                                <div class="font-bold text-sm text-gray-700">Магический Режим</div>
                                <div class="text-[10px] text-gray-500">Джокер, Рентген, Щит</div>
                            </div>
                        </div>
                        <div id="magic-toggle" class="w-6 h-6 rounded border-2 border-gray-400 bg-white flex items-center justify-center text-xs text-transparent transition-colors">
                            <i class="fas fa-check"></i>
                        </div>
                    </div>

                    <div class="border-t pt-4">
                        <button onclick="startOfflineGame()" class="w-full bg-gradient-to-r from-green-600 to-green-700 text-white font-bold py-4 rounded-lg shadow-lg hover:brightness-110 transition flex items-center justify-center gap-2 text-lg active:scale-95 transform duration-100">
                            <i class="fas fa-play"></i> Играть с Ботом
                        </button>
                    </div>

                    <div class="text-center">
                        <p class="text-xs text-gray-400 mb-2 mt-2 font-bold">ОНЛАЙН (BETA)</p>
                        <div id="online-controls" class="space-y-2 transition-opacity">
                            <button onclick="createOnlineGame()" class="w-full bg-blue-100 text-blue-700 font-bold py-2 rounded-lg text-sm hover:bg-blue-200 active:bg-blue-300">Создать Свою</button>
                            <div class="flex gap-2">
                                <input id="join-game-id" type="text" placeholder="ID (6 цифр)" class="flex-1 border-2 border-gray-300 p-2 rounded-lg text-center font-mono uppercase text-sm">
                                <button onclick="joinOnlineGame()" class="bg-blue-600 text-white font-bold px-4 rounded-lg text-sm hover:bg-blue-700 active:bg-blue-800">Войти</button>
                            </div>
                        </div>
                        <div id="auth-status" class="text-[10px] text-gray-400 mt-1">Проверка подключения...</div>
                    </div>
                </div>

                <!-- Экран ожидания (внутри левой панели) -->
                <div id="waiting-room" class="hidden absolute inset-0 bg-white z-10 flex flex-col items-center justify-center rounded-2xl">
                    <h2 class="text-xl font-bold mb-2 text-gray-800">Ожидание...</h2>
                    <div class="bg-yellow-100 p-4 rounded-lg mb-4 border-2 border-yellow-300">
                        <div class="text-sm text-gray-600">Код комнаты:</div>
                        <div id="display-game-id" class="text-4xl font-mono font-bold tracking-widest text-blue-700 select-all cursor-pointer" onclick="copyId()">------</div>
                    </div>
                    <p class="text-xs text-gray-500 mb-4 px-8 text-center">Сообщите этот код другу или ждите, пока кто-то войдет из списка.</p>
                    <button onclick="leaveGame()" class="text-red-500 hover:underline text-sm font-bold">Отмена</button>
                </div>
            </div>

            <!-- ПРАВАЯ КОЛОНКА: ОТКРЫТЫЕ КОМНАТЫ -->
            <div class="bg-white text-gray-800 p-6 rounded-2xl shadow-2xl w-full md:w-[320px] h-64 md:h-[550px] flex flex-col relative shrink-0">
                <div class="flex justify-between items-center mb-4 border-b border-gray-100 pb-2">
                    <span class="text-sm font-bold text-gray-600 uppercase tracking-wider flex items-center gap-2">
                        <i class="fas fa-globe text-blue-500"></i> Открытые Игры
                    </span>
                    <button onclick="refreshRoomList()" class="bg-blue-50 text-blue-600 w-8 h-8 rounded-full flex items-center justify-center hover:bg-blue-100 transition active:rotate-180 duration-300 shadow-sm" title="Обновить">
                        <i class="fas fa-sync-alt text-xs"></i>
                    </button>
                </div>
                
                <div id="rooms-list" class="flex-1 overflow-y-auto custom-scroll space-y-2 pr-1">
                    <div class="flex flex-col items-center justify-center h-full text-gray-400 gap-2 opacity-50">
                        <i class="fas fa-ghost text-3xl"></i>
                        <span class="text-xs">Нажмите обновить...</span>
                    </div>
                </div>
                
                <div class="text-[10px] text-gray-400 text-center mt-2 border-t pt-2">
                    Кликните на комнату для входа
                </div>
            </div>

        </div>
    </div>

    <!-- ИГРОВОЙ ИНТЕРФЕЙС -->
    <div id="game-ui" class="hidden h-full w-full relative">
        <!-- Верхняя панель -->
        <div class="absolute top-0 left-0 w-full p-2 flex justify-between items-start z-10 pointer-events-none">
            <div id="status-container" class="flex flex-col gap-2 pointer-events-auto">
                <div id="status-badge" class="bg-gray-700 text-white px-4 py-2 rounded-full text-sm font-bold shadow-lg backdrop-blur-md transition-colors">
                    Ожидание...
                </div>
                <!-- Мана (скрыта по дефолту) -->
                <div id="mana-container" class="hidden w-32 bg-gray-900 rounded-full h-4 border border-gray-600 relative overflow-hidden shadow-lg mt-1">
                    <div id="mana-bar" class="absolute top-0 left-0 h-full bg-gradient-to-r from-blue-500 to-cyan-400 w-0 transition-all duration-300"></div>
                    <div class="absolute inset-0 flex items-center justify-center text-[9px] font-bold text-white drop-shadow-md">MANA <span id="mana-val" class="ml-1">0</span></div>
                </div>
            </div>

            <div class="flex flex-col items-end gap-2 pointer-events-auto">
                <div class="bg-white/90 text-gray-900 px-3 py-1 rounded shadow text-sm font-bold flex items-center gap-2">
                    Козырь: <span id="trump-suit-display" class="text-xl leading-none"></span>
                </div>
                <!-- Магия Панель -->
                <div id="magic-panel" class="hidden flex flex-col gap-2 mt-1">
                    <button onclick="useSkill('peek')" id="btn-skill-peek" class="magic-btn bg-purple-600 hover:bg-purple-500" disabled>
                        <i class="fas fa-eye"></i><span class="magic-tooltip">Рентген (30)</span>
                    </button>
                    <button onclick="useSkill('swap')" id="btn-skill-swap" class="magic-btn bg-yellow-500 hover:bg-yellow-400" disabled>
                        <i class="fas fa-sync-alt"></i><span class="magic-tooltip">Обмен (40)</span>
                    </button>
                    <button onclick="useSkill('shield')" id="btn-skill-shield" class="magic-btn bg-blue-500 hover:bg-blue-400" disabled>
                        <i class="fas fa-shield-alt"></i><span class="magic-tooltip">Щит (50)</span>
                    </button>
                </div>
                <button onclick="leaveGame()" class="bg-red-500 hover:bg-red-600 text-white w-8 h-8 rounded-full flex items-center justify-center shadow"><i class="fas fa-times"></i></button>
            </div>
        </div>

        <div id="opponent-hand"></div>
        <div id="opponent-name" class="absolute top-16 left-1/2 transform -translate-x-1/2 text-white/70 text-sm font-bold bg-black/20 px-2 rounded">Bot AI</div>

        <!-- Колода -->
        <div id="deck-area" class="absolute left-4 top-1/2 transform -translate-y-1/2">
            <div class="relative w-[70px] h-[105px]">
                <div id="trump-card-el" class="absolute top-0 left-0 transition-all"></div>
                <div id="deck-stack" class="absolute top-0 left-0 w-full h-full bg-blue-900 border-2 border-white rounded-lg shadow-lg flex items-center justify-center transition-all cursor-help" title="Карт осталось">
                    <span id="deck-count" class="text-white font-bold text-xl">36</span>
                </div>
            </div>
        </div>

        <div id="game-table"></div>

        <!-- КНОПКИ (Z-Index 2000, Pointer-Events AUTO) -->
        <div id="action-area" class="absolute bottom-48 left-1/2 transform -translate-x-1/2 z-[2000] flex gap-6 hidden w-full justify-center pointer-events-none">
            <button id="btn-bito" onclick="performAction('bito')" class="btn-action btn-bito hidden shadow-lg pointer-events-auto">БИТО!</button>
            <button id="btn-take" onclick="performAction('take')" class="btn-action btn-take hidden shadow-lg pointer-events-auto">ВЗЯТЬ</button>
        </div>

        <!-- РУКА (СКРОЛЛ) -->
        <div id="player-hand-container">
            <div id="player-hand"></div>
        </div>

        <div id="toast" class="fixed top-2/3 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-black/80 text-white px-6 py-3 rounded-xl pointer-events-none transition-all opacity-0 scale-90 z-[2000] text-center border border-white/20 shadow-2xl">Msg</div>
        
        <!-- Эффекты -->
        <div id="effect-overlay" class="fixed inset-0 pointer-events-none z-[1500] flex items-center justify-center hidden">
            <h1 id="effect-text" class="text-6xl font-black text-yellow-400 drop-shadow-[0_5px_5px_rgba(0,0,0,0.8)] animate-bounce uppercase">EFFECT</h1>
        </div>
    </div>

    <!-- ЛОГИКА -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, updateDoc, onSnapshot, serverTimestamp, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- КОНФИГ ---
        const GAME_CONFIG = { mode: 'classic', deckSize: 36, magic: false };
        const COSTS = { PEEK: 30, SWAP: 40, SHIELD: 50 };
        const MANA_GAIN_ATTACK = 10;
        const MANA_GAIN_DEFEND = 20;

        const MY_CUSTOM_CONFIG = {
          apiKey: "AIzaSyBlfCYqHw_uHxP6pyKOkW0QFsuHFw9_XyY",
          authDomain: "durakweb3.firebaseapp.com",
          projectId: "durakweb3",
          storageBucket: "durakweb3.firebasestorage.app",
          messagingSenderId: "306514193440",
          appId: "1:306514193440:web:79d78252da6ee29c40a045",
          measurementId: "G-69VNYN2Z20"
        };

        const LOSER_JOKES = [
            "Ну ты даешь... даже хлеб умнее играет.",
            "Не расстраивайся, быть дураком - это призвание!",
            "У тебя карты были крапленые, я уверен.",
            "Бот просил передать, что ему было скучно.",
            "В следующий раз попробуй играть с открытыми глазами.",
            "Я видел, как голуби играют лучше."
        ];

        // --- STATE ---
        let GAME_MODE = 'OFFLINE'; 
        let currentUser = { uid: 'player-offline' };
        let currentGameId = null;
        let unsubscribeGame = null;
        let localState = null;
        let botTimer = null;
        let mana = 0;
        let shieldActive = false;
        let swapMode = false;
        let revealedBotIndices = [];
        let pendingCardChoice = null; // Карта для выбора (бить/перевести)

        // --- FIREBASE ---
        let db, auth, gamesRef;
        let isFirebaseReady = false;

        async function initFirebase() {
            try {
                let fbConfig = null;
                if (MY_CUSTOM_CONFIG) fbConfig = MY_CUSTOM_CONFIG;
                else if (typeof __firebase_config !== 'undefined') fbConfig = JSON.parse(__firebase_config);

                if (fbConfig && fbConfig.projectId) {
                    const app = initializeApp(fbConfig);
                    auth = getAuth(app);
                    db = getFirestore(app);
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default';
                    gamesRef = collection(db, 'artifacts', appId, 'public', 'data', 'games');
                    
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token);
                    else await signInAnonymously(auth);

                    onAuthStateChanged(auth, (user) => {
                        if (user) {
                            currentUser = user;
                            isFirebaseReady = true;
                            document.getElementById('auth-status').innerText = "Сервер подключен";
                            document.getElementById('auth-status').className = "text-[10px] text-green-600 mt-1 font-bold";
                            document.getElementById('online-controls').classList.remove('opacity-50', 'pointer-events-none');
                        }
                    });
                }
            } catch (e) {
                console.error("Firebase Init Error:", e);
                document.getElementById('auth-status').innerText = "Ошибка сети (только офлайн)";
            }
        }
        initFirebase();

        // --- МЕНЮ ---
        window.setMode = (m) => {
            GAME_CONFIG.mode = m;
            document.querySelectorAll('[id^="opt-mode-"]').forEach(el => el.classList.remove('active'));
            document.getElementById(`opt-mode-${m}`).classList.add('active');
        };
        window.setDeck = (s) => {
            GAME_CONFIG.deckSize = s;
            document.querySelectorAll('[id^="opt-deck-"]').forEach(el => el.classList.remove('active'));
            document.getElementById(`opt-deck-${s}`).classList.add('active');
        };
        window.toggleMagic = () => {
            GAME_CONFIG.magic = !GAME_CONFIG.magic;
            const check = document.getElementById('magic-toggle');
            if (GAME_CONFIG.magic) {
                check.classList.remove('text-transparent'); check.classList.add('bg-purple-600', 'border-purple-600', 'text-white');
            } else {
                check.classList.add('text-transparent'); check.classList.remove('bg-purple-600', 'border-purple-600', 'text-white');
            }
        };
        
        window.refreshRoomList = async () => {
            if (!isFirebaseReady) return showToast("Нет подключения");
            const listEl = document.getElementById('rooms-list');
            listEl.innerHTML = '<div class="text-center py-2"><i class="fas fa-spinner fa-spin text-gray-400"></i></div>';
            
            try {
                const snap = await getDocs(gamesRef);
                const rooms = [];
                snap.forEach(doc => {
                    const d = doc.data();
                    if (d.status === 'waiting') {
                        rooms.push({ id: doc.id, ...d });
                    }
                });
                
                listEl.innerHTML = '';
                if (rooms.length === 0) {
                    listEl.innerHTML = '<div class="text-[10px] text-gray-400 text-center py-2 flex flex-col items-center"><i class="far fa-folder-open mb-1"></i>Нет открытых игр</div>';
                    return;
                }
                
                rooms.forEach(r => {
                    const div = document.createElement('div');
                    div.className = 'bg-white p-2.5 rounded-lg border border-gray-200 flex justify-between items-center cursor-pointer hover:bg-blue-50 transition shadow-sm group';
                    div.onclick = () => {
                        document.getElementById('join-game-id').value = r.id;
                        joinOnlineGame(r.id);
                    };
                    const modeText = r.config ? (r.config.mode === 'transfer' ? 'Переводной' : 'Подкидной') : 'Подкидной';
                    const deckText = r.config ? r.config.deckSize : '36';
                    
                    div.innerHTML = `
                        <div class="flex items-center gap-2">
                             <div class="w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-bold text-xs">#${r.id.substring(0,1)}</div>
                             <div>
                                <div class="text-xs font-bold text-gray-700">Комната ${r.id}</div>
                                <div class="text-[10px] text-gray-500 font-medium">${modeText}, ${deckText}</div>
                            </div>
                        </div>
                        <span class="text-[9px] bg-green-100 text-green-700 px-2 py-1 rounded-full font-bold uppercase group-hover:bg-green-200 transition">Вход</span>
                    `;
                    listEl.appendChild(div);
                });
            } catch (e) {
                console.error(e);
                listEl.innerHTML = '<div class="text-[10px] text-red-400 text-center py-2">Ошибка загрузки</div>';
            }
        };

        // --- ЗАПУСК ---
        window.startOfflineGame = () => {
            GAME_MODE = 'OFFLINE';
            currentUser = { uid: 'player' };
            hideGameOver();
            mana = 0; shieldActive = false; swapMode = false; revealedBotIndices = []; pendingCardChoice = null;
            updateManaUI();
            
            document.getElementById('mana-container').classList.toggle('hidden', !GAME_CONFIG.magic);
            document.getElementById('magic-panel').classList.toggle('hidden', !GAME_CONFIG.magic);

            const deck = createDeck(GAME_CONFIG.deckSize, GAME_CONFIG.magic);
            const trump = deck[0];
            const pHand = [], bHand = [];
            const dealCount = Math.min(6, Math.floor((deck.length - 1) / 2));
            for(let i=0; i<dealCount; i++) { 
                if(deck.length) pHand.push(deck.pop()); 
                if(deck.length) bHand.push(deck.pop()); 
            }

            let playerFirst = true;
            if (trump.rank !== 'JOKER') {
                let pMin = 1000, bMin = 1000;
                pHand.forEach(c => { if(c.suit === trump.suit && c.val < pMin) pMin = c.val; });
                bHand.forEach(c => { if(c.suit === trump.suit && c.val < bMin) bMin = c.val; });
                playerFirst = (pMin < bMin) || (pMin === 1000 && bMin === 1000);
            }

            localState = {
                status: 'playing',
                deck: deck,
                trumpCard: trump,
                trumpSuit: trump.suit,
                hands: { 'player': pHand, 'bot': bHand },
                table: [],
                turn: playerFirst ? 'player' : 'bot',
                attacker: playerFirst ? 'player' : 'bot',
                hostId: 'player',
                joinerId: 'bot',
                config: { ...GAME_CONFIG }
            };

            showGameUI();
            renderGame(localState);
            if (localState.turn === 'bot') startBotTimer();
        };

        // --- ОНЛАЙН ---
        window.createOnlineGame = async () => {
            try {
                if (!isFirebaseReady) {
                    showError("Нет подключения к серверу. Попробуйте обновить.");
                    return;
                }
                GAME_MODE = 'ONLINE';
                const gameId = Math.floor(100000 + Math.random() * 900000).toString();
                const deck = createDeck(GAME_CONFIG.deckSize); 
                
                const state = {
                    hostId: currentUser.uid,
                    joinerId: null,
                    status: 'waiting',
                    deck: deck,
                    trumpCard: deck[0],
                    trumpSuit: deck[0].suit,
                    hands: { [currentUser.uid]: [] },
                    table: [],
                    turn: currentUser.uid,
                    attacker: currentUser.uid,
                    lastUpdate: serverTimestamp(),
                    config: { ...GAME_CONFIG } 
                };

                await setDoc(doc(gamesRef, gameId), state);
                currentGameId = gameId;
                // Скрываем меню, показываем ожидание
                document.getElementById('lobby-screen').classList.add('hidden');
                document.getElementById('waiting-room').classList.remove('hidden');
                // Важно: вставить Waiting Room обратно в DOM, если он был скрыт внутри лобби
                // У нас он внутри .bg-white wrapper, поэтому просто показываем его
                const waitingRoom = document.getElementById('waiting-room');
                const lobbyMain = document.getElementById('lobby-main');
                lobbyMain.classList.add('hidden');
                waitingRoom.classList.remove('hidden');
                // Показываем сам экран лобби, если он был скрыт
                document.getElementById('lobby-screen').classList.remove('hidden');

                document.getElementById('display-game-id').innerText = gameId;
                subscribeToGame(gameId);
            } catch (e) {
                console.error("Create Game Error:", e);
                showError("Не удалось создать игру: " + e.message);
            }
        };

        window.joinOnlineGame = async (optId) => {
            try {
                if (!isFirebaseReady) {
                    showError("Нет подключения.");
                    return;
                }
                const inputId = optId || document.getElementById('join-game-id').value.trim();
                if (inputId.length !== 6) return showToast("ID должен быть из 6 цифр");
                GAME_MODE = 'ONLINE';

                const gameRef = doc(gamesRef, inputId);
                const snap = await getDoc(gameRef);
                if (!snap.exists()) return showError("Комната не найдена");
                const data = snap.data();
                if (data.status !== 'waiting') return showError("Игра уже идет");

                // Применяем настройки хоста
                GAME_CONFIG.deckSize = data.config.deckSize;
                GAME_CONFIG.mode = data.config.mode;
                GAME_CONFIG.magic = false; // Force magic off in online

                const deck = [...data.deck];
                const h1 = [], h2 = [];
                for(let i=0; i<6; i++) { if(deck.length) h1.push(deck.pop()); if(deck.length) h2.push(deck.pop()); }

                await updateDoc(gameRef, {
                    joinerId: currentUser.uid,
                    status: 'playing',
                    deck: deck,
                    [`hands.${data.hostId}`]: h1,
                    [`hands.${currentUser.uid}`]: h2,
                    attacker: data.hostId, 
                    turn: data.hostId
                });

                currentGameId = inputId;
                subscribeToGame(inputId);
            } catch (e) {
                console.error("Join Game Error:", e);
                showError("Ошибка входа: " + e.message);
            }
        };
        
        function subscribeToGame(id) {
            unsubscribeGame = onSnapshot(doc(gamesRef, id), (snap) => {
                if(!snap.exists()) {
                    showToast("Игра завершена или отменена");
                    leaveGame();
                    return;
                }
                const d = snap.data();
                localState = d;
                
                if (d.status === 'playing') {
                    // Mapping online IDs to 'player' and 'bot'
                    const myUid = currentUser.uid;
                    const oppUid = d.hostId === myUid ? d.joinerId : d.hostId;
                    
                    // Temporary patch localState
                    localState.hands['player'] = d.hands[myUid];
                    localState.hands['bot'] = d.hands[oppUid];
                    localState.turn = d.turn === myUid ? 'player' : 'bot';
                    localState.attacker = d.attacker === myUid ? 'player' : 'bot';
                    
                    showGameUI();
                    renderGame(localState);
                }
            }, (error) => {
                 console.error("Snapshot error:", error);
                 // Don't leave game immediately on error to avoid flicker, just toast
            });
        }


        // --- ЛОГИКА ИГРОКА ---
        window.globalClick = (e) => {
            if (pendingCardChoice && !e.target.closest('.card') && !e.target.closest('.phantom-card') && !e.target.closest('.beat-target')) {
                cancelChoice();
            }
        };

        window.playerCardClick = (card, event) => {
            if(event) event.stopPropagation();
            if (swapMode) { doSwap(card); return; }

            const state = localState;
            const isMyTurn = state.turn === 'player';
            const amIAttacker = state.attacker === 'player';
            const matchesTable = state.table.some(p => p.attack.rank === card.rank || (p.defend && p.defend.rank === card.rank));
            
            // --- ПЕРЕВОД ---
            if (GAME_CONFIG.mode === 'transfer' && !amIAttacker && isMyTurn) { // Только если мой ход (защита)
                if (state.table.length > 0 && state.table.every(p => !p.defend)) {
                    if (card.rank === state.table[0].attack.rank && card.rank !== 'JOKER') {
                        if (state.hands['bot'].length >= state.table.length + 1) {
                            // Проверка на выбор (БИТЬ или ПЕРЕВЕСТИ)
                            const att = state.table[0].attack;
                            const canDefendToo = canBeat(card, att, state.trumpSuit);
                            if (canDefendToo) {
                                pendingCardChoice = card;
                                renderGame(state);
                                showToast("Нажми карту: бить (красная) или перевести (синяя)?");
                                return;
                            } else {
                                if (botTimer) clearTimeout(botTimer);
                                performTransfer(card, 'player');
                                return;
                            }
                        } else {
                            showToast("У соперника мало карт!");
                            return;
                        }
                    }
                }
            }

            if (!isMyTurn && !(amIAttacker && matchesTable)) return showToast("Ждите...");

            if (amIAttacker) {
                // АТАКА
                if (state.hands['bot'].length === 0) { showToast("У соперника нет карт!"); return; }
                if (state.table.length > 0 && !matchesTable) return showToast("Ранг не совпадает");
                if (state.table.length >= 6) return showToast("Стол полон");
                if (shieldActive && state.table.length > 0) return showToast("Щит активен!");

                if (botTimer) clearTimeout(botTimer);
                applyMove(card, 'attack', -1, 'player');
                addMana(MANA_GAIN_ATTACK);
            } else {
                // ЗАЩИТА
                if (!isMyTurn) return showToast("Ждите...");
                const pairIdx = state.table.findIndex(p => !p.defend);
                if (pairIdx === -1) return; 
                const att = state.table[pairIdx].attack;
                if (!canBeat(card, att, state.trumpSuit)) return showToast("Не бьёт!");
                
                applyMove(card, 'defend', pairIdx, 'player');
                addMana(MANA_GAIN_DEFEND);
            }
        };

        window.resolveChoice = (choice) => {
            if (!pendingCardChoice) return;
            const card = pendingCardChoice;
            pendingCardChoice = null;
            if (choice === 'transfer') {
                if (botTimer) clearTimeout(botTimer);
                performTransfer(card, 'player');
            } else { // Beat
                if (botTimer) clearTimeout(botTimer);
                applyMove(card, 'defend', 0, 'player'); 
                addMana(MANA_GAIN_DEFEND);
            }
        };
        window.cancelChoice = () => { pendingCardChoice = null; renderGame(localState); };

        window.performAction = (type) => {
            if (botTimer) clearTimeout(botTimer);
            if (type === 'bito') endTurn(true);
            else endTurn(false);
        };

        // --- ЯДРО ХОДОВ ---
        function removeCardFromHand(hand, cardToRemove) {
            const idx = hand.findIndex(c => c.rank === cardToRemove.rank && c.suit === cardToRemove.suit);
            if (idx !== -1) hand.splice(idx, 1);
        }

        async function applyMove(card, type, idx, who) {
            const state = localState;
            removeCardFromHand(state.hands[who], card);

            let newTurn = state.turn;

            if (type === 'attack') {
                state.table.push({ attack: card, defend: null });
                state.turn = (who === 'player' ? 'bot' : 'player'); // Переход хода защищающемуся
                if (who === 'player' && GAME_MODE === 'OFFLINE') startBotTimer();
            } else {
                state.table[idx].defend = card;
                const hasUndefended = state.table.some(p => !p.defend);
                if (!hasUndefended) {
                    state.turn = state.attacker; // Всё отбито -> ход Атакующего
                    if (state.attacker === 'bot' && GAME_MODE === 'OFFLINE') startBotTimer();
                } else if (who === 'bot' && GAME_MODE === 'OFFLINE') {
                    startBotTimer(); // Бот продолжает бить
                }
            }

            if (GAME_MODE === 'ONLINE') {
                const myUid = currentUser.uid;
                const oppUid = state.hostId === myUid ? state.joinerId : state.hostId;
                await updateDoc(doc(gamesRef, currentGameId), {
                    [`hands.${myUid}`]: state.hands.player,
                    [`hands.${oppUid}`]: state.hands.bot,
                    table: state.table,
                    turn: state.turn === 'player' ? myUid : oppUid,
                    attacker: state.attacker === 'player' ? myUid : oppUid
                });
            } else {
                renderGame(state);
            }
        }

        async function performTransfer(card, who) {
            const state = localState;
            const victim = (who === 'player' ? 'bot' : 'player');
            removeCardFromHand(state.hands[who], card);
            state.table.push({ attack: card, defend: null });
            
            // СМЕНА РОЛЕЙ
            state.attacker = who;
            state.turn = victim;
            
            if (GAME_MODE === 'ONLINE') {
                const myUid = currentUser.uid;
                const oppUid = state.hostId === myUid ? state.joinerId : state.hostId;
                await updateDoc(doc(gamesRef, currentGameId), {
                    [`hands.${myUid}`]: state.hands.player,
                    [`hands.${oppUid}`]: state.hands.bot,
                    table: state.table,
                    turn: state.turn === 'player' ? myUid : oppUid,
                    attacker: state.attacker === 'player' ? myUid : oppUid
                });
            } else {
                renderGame(state);
                if (who === 'player') { showEffect("ПЕРЕВОД!"); startBotTimer(); }
            }
        }

        async function endTurn(success) { // success = BITO
            const state = localState;
            const defender = (state.attacker === 'player' ? 'bot' : 'player');
            const attacker = state.attacker;

            if (success) {
                // БИТО
                state.table = [];
                drawCards(attacker);
                drawCards(defender);
                // Смена ролей
                state.attacker = defender;
                state.turn = defender;
            } else {
                // ВЗЯЛ
                let cards = [];
                state.table.forEach(p => { cards.push(p.attack); if(p.defend) cards.push(p.defend); });
                state.hands[defender].push(...cards);
                state.table = [];
                drawCards(attacker);
                // Роли НЕ меняются (Атакующий ходит снова)
                state.turn = attacker; 
            }

            shieldActive = false; 
            revealedBotIndices = [];
            document.getElementById('player-hand').classList.remove('shield-active');

            if (GAME_MODE === 'ONLINE') {
                const myUid = currentUser.uid;
                const oppUid = state.hostId === myUid ? state.joinerId : state.hostId;
                await updateDoc(doc(gamesRef, currentGameId), {
                    deck: state.deck,
                    [`hands.${myUid}`]: state.hands.player,
                    [`hands.${oppUid}`]: state.hands.bot,
                    table: state.table,
                    turn: state.turn === 'player' ? myUid : oppUid,
                    attacker: state.attacker === 'player' ? myUid : oppUid
                });
            } else {
                renderGame(state);
                if (state.turn === 'bot') startBotTimer();
            }
        }

        // --- БОТ ---
        function startBotTimer() {
            if (botTimer) clearTimeout(botTimer);
            botTimer = setTimeout(botTurn, 1000);
        }

        function botTurn() {
            if (!localState || localState.turn !== 'bot') return;
            const state = localState;
            if (checkGameOver(state)) return;

            const botHand = state.hands['bot'];
            const amIAttacker = state.attacker === 'bot';

            // TRANSFER CHECK
            if (GAME_CONFIG.mode === 'transfer' && !amIAttacker) {
                if (state.table.length > 0 && state.table.every(p => !p.defend)) {
                    const rank = state.table[0].attack.rank;
                    const transferCard = botHand.find(c => c.rank === rank && c.rank !== 'JOKER');
                    if (transferCard && state.hands['player'].length >= state.table.length + 1) {
                        performTransfer(transferCard, 'bot');
                        return;
                    }
                }
            }

            if (amIAttacker) {
                // Проверка: есть ли у игрока карты?
                if (state.hands['player'].length === 0) {
                    performAction('bito'); // Некуда кидать
                    return;
                }

                if (state.table.length === 0) {
                    const c = getLowestCard(botHand, state.trumpSuit);
                    if (c) applyMove(c, 'attack', -1, 'bot');
                    else performAction('bito');
                } else {
                    if (shieldActive) { performAction('bito'); return; }
                    
                    const ranks = new Set();
                    state.table.forEach(p => { ranks.add(p.attack.rank); if(p.defend) ranks.add(p.defend.rank); });
                    const options = botHand.filter(c => ranks.has(c.rank));
                    
                    if (options.length > 0 && state.table.length < 6) {
                        options.sort((a,b) => getCardPower(a, state.trumpSuit) - getCardPower(b, state.trumpSuit));
                        applyMove(options[0], 'attack', -1, 'bot');
                    } else {
                        // Жмем Бито только если все отбито
                        if (state.table.every(p => p.defend)) {
                            performAction('bito');
                        }
                    }
                }
            } else {
                // DEFEND
                const idx = state.table.findIndex(p => !p.defend);
                if (idx === -1) return; // Всё отбито

                const att = state.table[idx].attack;
                let beaters = botHand.filter(c => canBeat(c, att, state.trumpSuit));
                
                if (beaters.length > 0) {
                    beaters.sort((a,b) => getCardPower(a, state.trumpSuit) - getCardPower(b, state.trumpSuit));
                    applyMove(beaters[0], 'defend', idx, 'bot');
                } else {
                    performAction('take');
                }
            }
        }

        // --- SKILLS ---
        window.useSkill = (skill) => {
            if (!GAME_CONFIG.magic) return;
            if (skill === 'peek') {
                if (mana < COSTS.PEEK) return showToast("Мало маны!");
                const botH = localState.hands['bot'];
                if(botH.length === 0) return;
                mana -= COSTS.PEEK;
                revealedBotIndices = [];
                const indices = Array.from({length: botH.length}, (_, i) => i);
                for(let i=0; i < Math.min(2, botH.length); i++) {
                    const rnd = Math.floor(Math.random() * indices.length);
                    revealedBotIndices.push(indices[rnd]);
                    indices.splice(rnd, 1);
                }
                showEffect("РЕНТГЕН");
                renderGame(localState);
                setTimeout(() => { revealedBotIndices = []; renderGame(localState); }, 3000);
            } 
            else if (skill === 'shield') {
                if (mana < COSTS.SHIELD) return showToast("Мало маны!");
                if (localState.attacker === 'player') return showToast("Щит только в защите!");
                mana -= COSTS.SHIELD;
                shieldActive = true;
                showEffect("ЩИТ!");
                document.getElementById('player-hand').classList.add('shield-active');
            }
            else if (skill === 'swap') {
                if (mana < COSTS.SWAP) return showToast("Мало маны!");
                if (localState.deck.length === 0) return showToast("Колода пуста!");
                mana -= COSTS.SWAP;
                swapMode = true;
                showToast("Выберите карту");
                document.querySelectorAll('.hand-card-wrapper .card').forEach(el => el.classList.add('card-swapping'));
            }
            updateManaUI();
        }

        function doSwap(card) {
            const state = localState;
            removeCardFromHand(state.hands['player'], card);
            if (state.deck.length > 0) state.hands['player'].push(state.deck.pop());
            state.deck.unshift(card); 
            swapMode = false;
            document.querySelectorAll('.hand-card-wrapper .card').forEach(el => el.classList.remove('card-swapping'));
            showEffect("ОБМЕН");
            renderGame(state);
        }

        // --- UTIL ---
        function createDeck(size, magic) {
            const suits = ['hearts','diamonds','clubs','spades'];
            let ranks = [];
            let values = {};
            if (size == 24) { ranks = ['9','10','J','Q','K','A']; ranks.forEach((r,i)=>values[r]=i+3); }
            else if (size == 52) { ranks = ['2','3','4','5','6','7','8','9','10','J','Q','K','A']; ranks.forEach((r,i)=>values[r]=i); }
            else { ranks = ['6','7','8','9','10','J','Q','K','A']; ranks.forEach((r,i)=>values[r]=i); }
            let d = [];
            for (let s of suits) for (let r of ranks) d.push({suit:s, rank:r, val:values[r]});
            if (magic) d.push({ suit: 'joker', rank: 'JOKER', val: 999 });
            for(let i=d.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[d[i],d[j]]=[d[j],d[i]];}
            return d;
        }

        function canBeat(card, target, trumpSuit) {
            if (target.rank === 'JOKER') return (card.suit === trumpSuit && (card.rank === '6' || card.rank === '2'));
            if (card.rank === 'JOKER') return true;
            if (card.suit === target.suit) return card.val > target.val;
            if (card.suit === trumpSuit && target.suit !== trumpSuit) return true;
            return false;
        }

        function getCardPower(c, trumpSuit) {
            if (c.rank === 'JOKER') return 200;
            return c.val + (c.suit === trumpSuit ? 100 : 0);
        }

        function getLowestCard(hand, trumpSuit) {
            if (hand.length === 0) return null;
            return hand.reduce((prev, curr) => getCardPower(prev, trumpSuit) < getCardPower(curr, trumpSuit) ? prev : curr);
        }

        function drawCards(who) {
            const state = localState;
            while (state.hands[who].length < 6 && state.deck.length > 0) {
                state.hands[who].push(state.deck.pop());
            }
            state.hands[who].sort((a,b) => getCardPower(a, state.trumpSuit) - getCardPower(b, state.trumpSuit));
        }

        function addMana(amt) {
            if (!GAME_CONFIG.magic) return;
            mana = Math.min(100, mana + amt);
            updateManaUI();
        }

        function checkGameOver(state) {
            if (state.deck.length === 0) {
                const myH = state.hands['player'].length;
                const botH = state.hands['bot'].length;
                if (myH === 0 && botH === 0) { showGameOver('draw'); return true; }
                if (myH === 0) { showGameOver('win'); return true; }
                if (botH === 0) { showGameOver('lose'); return true; }
            }
            return false;
        }

        function renderGame(state) {
            if (!state || checkGameOver(state)) return;
            
            const badge = document.getElementById('status-badge');
            if (state.turn === 'player') {
                badge.innerText = state.attacker === 'player' ? "ВАШ ХОД (Атака)" : "ВАШ ХОД (Защита)";
                badge.className = "bg-green-600 text-white px-4 py-1.5 rounded-full text-sm font-bold shadow animate-pulse border border-green-400";
            } else {
                badge.innerText = "Ход Бота...";
                badge.className = "bg-gray-700 text-white px-4 py-1.5 rounded-full text-sm font-bold shadow border border-gray-600";
            }

            document.getElementById('deck-count').innerText = state.deck.length;
            const tEl = document.getElementById('trump-card-el');
            tEl.innerHTML = renderCardHTML(state.trumpCard);
            tEl.style.transform = 'rotate(90deg) translateX(30px)';
            document.getElementById('trump-suit-display').innerHTML = getSuitIconHtml(state.trumpSuit);
            
            if(state.deck.length === 0) {
                document.getElementById('deck-stack').classList.add('hidden');
                tEl.style.opacity = '0.5';
            } else {
                document.getElementById('deck-stack').classList.remove('hidden');
                tEl.style.opacity = '1';
            }

            const tbl = document.getElementById('game-table');
            tbl.innerHTML = '';
            state.table.forEach(p => {
                const s = document.createElement('div'); s.className = 'table-slot';
                
                // Рендер Атаки + Фантом (если выбор)
                const isTarget = pendingCardChoice && !p.defend;
                const onclickAttr = isTarget ? `onclick="resolveChoice('beat')"` : '';
                const targetClass = isTarget ? 'beat-target' : '';
                
                let attackHtml = `<div class="card ${targetClass}" style="top:0;left:0" ${onclickAttr}>${renderCardInner(p.attack)}</div>`;
                s.innerHTML = attackHtml;

                if (pendingCardChoice && !p.defend) {
                    s.innerHTML += `<div class="phantom-card" onclick="resolveChoice('transfer')"><i class="fas fa-share text-3xl mb-1"></i><span class="text-[10px] font-bold uppercase">Перевод</span></div>`;
                }

                if(p.defend) s.innerHTML += `<div class="card" style="top:20px;left:20px;z-index:5">${renderCardInner(p.defend)}</div>`;
                tbl.appendChild(s);
            });

            const pHand = document.getElementById('player-hand'); pHand.innerHTML = '';
            state.hands['player'].forEach(c => {
                const div = document.createElement('div'); div.className = 'hand-card-wrapper';
                const cls = (c.rank === 'JOKER') ? 'card card-joker' : 'card';
                const isSelected = pendingCardChoice && c.rank === pendingCardChoice.rank && c.suit === pendingCardChoice.suit;
                const selectedClass = isSelected ? ' card-selected-action' : '';
                const swapClass = (swapMode) ? ' card-swapping' : '';
                div.innerHTML = `<div class="${cls}${swapClass}${selectedClass}" onclick='playerCardClick(${JSON.stringify(c)}, event)'>${renderCardInner(c)}</div>`;
                pHand.appendChild(div);
            });

            const bHand = document.getElementById('opponent-hand'); bHand.innerHTML = '';
            for(let i=0; i<state.hands['bot'].length; i++) {
                const d = document.createElement('div');
                const isRevealed = revealedBotIndices.includes(i);
                d.className = isRevealed ? 'opponent-card-back opponent-card-revealed' : 'opponent-card-back';
                d.innerHTML = isRevealed ? renderCardInner(state.hands['bot'][i]) : '';
                bHand.appendChild(d);
            }

            const area = document.getElementById('action-area');
            const btnBito = document.getElementById('btn-bito');
            const btnTake = document.getElementById('btn-take');
            area.classList.add('hidden'); btnBito.classList.add('hidden'); btnTake.classList.add('hidden');

            if (state.table.length > 0) {
                if (state.attacker === 'player') {
                    if (state.table.every(p => p.defend)) {
                        area.classList.remove('hidden'); btnBito.classList.remove('hidden');
                    }
                } else {
                    if (state.turn === 'player') {
                        area.classList.remove('hidden'); btnTake.classList.remove('hidden');
                    }
                }
            }
            
            document.getElementById('btn-skill-peek').disabled = mana < COSTS.PEEK;
            document.getElementById('btn-skill-swap').disabled = mana < COSTS.SWAP || state.deck.length === 0;
            document.getElementById('btn-skill-shield').disabled = mana < COSTS.SHIELD;
            updateManaUI();
        }

        function renderCardHTML(c) {
            const cls = (c.rank === 'JOKER') ? 'card card-joker' : 'card';
            return `<div class="${cls}">${renderCardInner(c)}</div>`;
        }

        function renderCardInner(c) {
            if (c.rank === 'JOKER') return `<div class="flex flex-col items-center justify-center h-full"><i class="fas fa-hat-wizard text-4xl"></i><div class="font-bold text-[10px]">JOKER</div></div>`;
            const color = (c.suit === 'hearts' || c.suit === 'diamonds') ? 'suit-red' : 'suit-black';
            const icon = getSuitChar(c.suit);
            return `<div class="text-left font-bold text-sm leading-none ${color} p-1">${c.rank}</div><div class="flex-grow flex items-center justify-center text-4xl ${color}">${icon}</div><div class="text-right font-bold text-sm leading-none transform rotate-180 ${color} p-1">${c.rank}</div>`;
        }

        function getSuitChar(s) { return {'hearts':'♥','diamonds':'♦','clubs':'♣','spades':'♠', 'joker':'★'}[s] || ''; }
        function getSuitIconHtml(s) { 
            const c = (s==='hearts'||s==='diamonds')?'text-red-500':'text-gray-900';
            const ch = getSuitChar(s);
            return `<span class="${c}">${ch}</span>`;
        }
        function updateManaUI() { document.getElementById('mana-bar').style.width = mana + '%'; document.getElementById('mana-val').innerText = mana; }
        
        function showGameOver(res) {
            document.getElementById('game-over-screen').classList.remove('hidden', 'opacity-0');
            const t = document.getElementById('go-title');
            const m = document.getElementById('go-message');
            if(res==='win'){ t.innerText="ПОБЕДА!"; t.className="text-6xl font-black mb-4 text-green-500"; m.innerText="Красава!"; }
            else if(res==='lose'){ t.innerText="ВЫ ПРОИГРАЛИ"; t.className="text-6xl font-black mb-4 text-red-600"; m.innerText=`"${LOSER_JOKES[Math.floor(Math.random()*LOSER_JOKES.length)]}"`; }
            else { t.innerText="НИЧЬЯ"; t.className="text-6xl font-black mb-4 text-yellow-400"; m.innerText="Мир!"; }
        }

        window.copyId = () => { navigator.clipboard.writeText(currentGameId); showToast("ID скопирован"); }
        window.leaveGame = () => {
            if(unsubscribeGame) unsubscribeGame();
            document.getElementById('game-ui').classList.add('hidden');
            document.getElementById('waiting-room').classList.add('hidden');
            document.getElementById('lobby-screen').classList.remove('hidden');
            // FIX: Restore lobby layout visibility
            document.getElementById('lobby-main').classList.remove('hidden'); 
            localState = null;
        };
        window.hideGameOver = () => document.getElementById('game-over-screen').classList.add('hidden');
        window.closeErrorModal = () => document.getElementById('error-modal').classList.add('hidden');
        window.showError = (msg) => {
            document.getElementById('error-text').innerText = msg;
            document.getElementById('error-modal').classList.remove('hidden');
        };
        window.showGameUI = () => { document.getElementById('lobby-screen').classList.add('hidden'); document.getElementById('game-ui').classList.remove('hidden'); };
        window.showToast = (m) => { const t=document.getElementById('toast'); t.innerText=m; t.classList.remove('opacity-0','scale-90'); setTimeout(()=>t.classList.add('opacity-0','scale-90'), 2000); };
        function showEffect(txt) {
            const el = document.getElementById('effect-overlay');
            document.getElementById('effect-text').innerText = txt;
            el.classList.remove('hidden');
            setTimeout(()=>el.classList.add('hidden'), 1500);
        }
    </script>
</body>
</html>
