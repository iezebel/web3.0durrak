<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Durak Online</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --bg-color: #2a5c32;
            --bg-pattern: #1a3c22;
            --btn-color: #ffcc00;
        }

        body {
            margin: 0; padding: 0;
            background-color: var(--bg-color);
            background-image: radial-gradient(circle at center, var(--bg-color) 0%, var(--bg-pattern) 100%);
            color: white;
            font-family: -apple-system, sans-serif;
            overflow: hidden;
            display: flex; flex-direction: column;
            height: 100vh;
            user-select: none; -webkit-user-select: none;
        }

        /* –ú–ï–ù–Æ */
        #menu-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(20, 40, 25, 0.98);
            z-index: 2000;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            gap: 15px;
            padding: 20px; box-sizing: border-box;
        }

        .menu-title {
            font-size: 36px; font-weight: 900; color: var(--btn-color);
            margin-bottom: 10px; text-transform: uppercase; text-align: center;
        }

        input {
            padding: 15px; border-radius: 12px;
            border: 2px solid rgba(255,255,255,0.2);
            background: rgba(0,0,0,0.3);
            color: white; font-size: 18px; text-align: center;
            width: 100%; max-width: 300px; outline: none; margin-bottom: 10px;
        }

        .menu-btn {
            background: var(--btn-color); color: #2e2e2e;
            border: none; padding: 15px 0; border-radius: 12px;
            font-size: 18px; font-weight: 800; cursor: pointer;
            width: 100%; max-width: 300px; text-transform: uppercase;
            box-shadow: 0 4px 0 #c29d00; margin-bottom: 10px;
        }
        .menu-btn:active { transform: translateY(4px); box-shadow: none; }
        .menu-btn:disabled { background: #555; color: #888; box-shadow: none; cursor: not-allowed; }

        .row { display: flex; gap: 10px; width: 100%; max-width: 300px; justify-content: center;}

        /* –ö–û–ù–°–û–õ–¨ –û–¢–õ–ê–î–ö–ò */
        #debug-console {
            margin-top: 15px;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            color: #00ff00;
            background: rgba(0,0,0,0.9);
            padding: 10px;
            border-radius: 8px;
            width: 100%; max-width: 350px;
            height: 120px;
            overflow-y: auto;
            text-align: left;
            border: 1px solid #444;
        }
        .log-err { color: #ff5555; font-weight: bold; }
        .log-ok { color: #55ff55; }
        .log-warn { color: #ffff55; }
        .log-info { color: #aaa; }

        /* –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –û–®–ò–ë–ö–ò */
        #error-modal {
            display: none;
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 5000;
            flex-direction: column;
            justify-content: center; align-items: center;
            padding: 20px; text-align: center;
        }
        #error-modal h2 { color: #ff5555; margin-bottom: 10px; }
        #error-modal p { margin-bottom: 20px; color: #ccc; font-size: 14px; max-width: 400px; }
        #manual-key-input { border: 1px solid #ff5555; width: 100%; max-width: 350px; }

        /* –ò–ì–†–û–í–û–ô –≠–ö–†–ê–ù */
        #game-screen {
            display: none; flex: 1; position: relative;
            flex-direction: column; height: 100%;
        }

        /* –ö–ê–†–¢–´ */
        .card {
            width: 70px; height: 100px;
            background: white; border-radius: 8px; color: black;
            position: relative; box-shadow: 0 2px 5px rgba(0,0,0,0.5);
            margin-right: -25px; cursor: pointer; flex-shrink: 0;
            font-family: 'Arial', sans-serif; font-weight: bold;
        }
        .card:last-child { margin-right: 0; }
        .card.red { color: #d40000; }
        
        .card-top-left { position: absolute; top: 4px; left: 4px; font-size: 14px; line-height: 1; display: flex; flex-direction: column; align-items: center; }
        .card-bottom-right { position: absolute; bottom: 4px; right: 4px; font-size: 14px; line-height: 1; display: flex; flex-direction: column; align-items: center; transform: rotate(180deg); }
        .card-center { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 32px; }
        .card-back { background: #4a7c59; border: 2px solid white; background-image: repeating-linear-gradient(45deg, #4a7c59 0, #4a7c59 10px, #3b6346 10px, #3b6346 20px); }

        .hand { display: flex; justify-content: center; height: 110px; width: 100%; position: relative; }
        .opponent-hand { margin-top: 10px; }
        .player-hand { margin-bottom: 80px; overflow-x: auto; padding: 0 20px; justify-content: flex-start; }
        .table-area { flex: 1; display: flex; justify-content: center; align-items: center; position: relative; }
        .table-slots { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; padding-left: 80px;}
        .slot { width: 70px; height: 100px; position: relative; }
        .slot .card { position: absolute; top: 0; left: 0; }
        .slot .defending { top: 15px; left: 15px; transform: rotate(15deg); z-index: 10; }
        .deck-area { position: absolute; left: 20px; top: 50%; transform: translateY(-50%); }
        .deck-stack { width: 70px; height: 100px; background: #1a3c22; border: 2px solid white; border-radius: 8px; display: flex; justify-content: center; align-items: center; font-weight: bold; font-size: 20px; z-index: 2; position: relative;}
        .trump-card-container { position: absolute; top: 0; left: 20px; width: 70px; height: 100px; transform: rotate(90deg) translateX(-20px); z-index: 1; }
        
        .top-bar { padding: 10px; background: rgba(0,0,0,0.3); display: flex; justify-content: space-between; }
        .controls { position: absolute; bottom: 20px; width: 100%; display: flex; justify-content: center; pointer-events: none; }
        .game-btn { pointer-events: auto; background: var(--btn-color); border: none; padding: 12px 40px; border-radius: 30px; font-size: 18px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 0 #c29d00; transition: 0.1s;}
        .game-btn:active { transform: translateY(4px); box-shadow: none; }
        .game-btn:disabled { background: #888; color: #ccc; cursor: not-allowed; box-shadow: none; transform: translateY(4px); }
        .status-msg { position: absolute; top: 40%; width: 100%; text-align: center; background: rgba(0,0,0,0.5); padding: 10px; font-size: 20px; font-weight: bold; display: none; z-index: 100;}
    </style>
</head>
<body>

    <!-- –ú–ï–ù–Æ -->
    <div id="menu-screen">
        <div class="menu-title">Durak Online</div>
        
        <input type="text" id="player-name" placeholder="–í–∞—à–µ –∏–º—è" maxlength="12">
        
        <button id="btn-create" class="menu-btn" onclick="createGame()" disabled>–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</button>
        
        <div class="row">
            <input type="text" id="join-code" placeholder="–ö–æ–¥" style="width: 100px; margin:0; text-transform:uppercase;">
            <button id="btn-join" class="menu-btn" onclick="joinGameInput()" style="width: 160px;" disabled>–í–æ–π—Ç–∏</button>
        </div>

        <div id="debug-console">
            <div class="log-info">–ó–∞–ø—É—Å–∫ —Å–∏—Å—Ç–µ–º—ã...</div>
        </div>
    </div>

    <!-- –ú–û–î–ê–õ–ö–ê –û–®–ò–ë–ö–ò -->
    <div id="error-modal">
        <h2 id="modal-title">–û—à–∏–±–∫–∞!</h2>
        <p id="modal-desc">–û–ø–∏—Å–∞–Ω–∏–µ –æ—à–∏–±–∫–∏...</p>
        
        <div id="key-fix-ui" style="display:none; width:100%; display:flex; flex-direction:column; align-items:center;">
            <p style="color:#ffcc00; margin-bottom:5px;">–í—Å—Ç–∞–≤—å—Ç–µ apiKey –∏–∑ Firebase Console:</p>
            <input type="text" id="manual-key-input" placeholder="AIzaSy...">
            <button class="menu-btn" onclick="saveManualKey()" style="margin-top:10px;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å</button>
        </div>
        
        <button id="modal-close" onclick="closeModal()" style="margin-top:20px; background:transparent; border:1px solid #aaa; color:#aaa; padding:5px 20px; border-radius:5px; cursor:pointer;">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>

    <!-- –ò–ì–†–ê -->
    <div id="game-screen">
        <div class="top-bar">
            <div>–Ø: <b id="ui-my-name">...</b></div>
            <div onclick="copyCode()" style="cursor:pointer; background:rgba(255,255,255,0.2); padding:2px 8px; border-radius:4px;">ID: <span id="ui-game-code">...</span> üìã</div>
            <div>–í—Ä–∞–≥: <b id="ui-opp-name">...</b></div>
        </div>

        <div class="table-area">
            <div class="deck-area">
                <div id="trump-placeholder"></div>
                <div class="deck-stack" id="deck-count"></div>
            </div>
            <div class="table-slots" id="table"></div>
        </div>

        <div class="status-msg" id="status-display"></div>

        <div class="hand opponent-hand" id="opponent-hand"></div>
        <div class="hand player-hand" id="player-hand"></div>

        <div class="controls">
            <button id="btn-action" class="game-btn" onclick="doAction()">...</button>
        </div>
    </div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    function log(msg, type='info') {
        const c = document.getElementById('debug-console');
        const l = document.createElement('div');
        l.className = `log-${type}`;
        l.innerText = `> ${msg}`;
        c.appendChild(l);
        c.scrollTop = c.scrollHeight;
    }

    function showModal(title, desc, showKeyInput = false) {
        document.getElementById('error-modal').style.display = 'flex';
        document.getElementById('modal-title').innerText = title;
        document.getElementById('modal-desc').innerHTML = desc;
        document.getElementById('key-fix-ui').style.display = showKeyInput ? 'flex' : 'none';
        document.getElementById('modal-close').style.display = showKeyInput ? 'none' : 'block';
    }

    function closeModal() {
        document.getElementById('error-modal').style.display = 'none';
    }

    function saveManualKey() {
        const k = document.getElementById('manual-key-input').value.trim();
        if (k.length < 10) return alert("–°–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π –∫–ª—é—á");
        localStorage.setItem('custom_api_key', k);
        location.reload();
    }

    // --- –ü–†–û–í–ï–†–ö–ê –ü–†–û–¢–û–ö–û–õ–ê ---
    if (window.location.protocol === 'file:') {
        setTimeout(() => {
            showModal(
                "–ó–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ –§–∞–π–ª!", 
                "Firebase –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –¥–≤–æ–π–Ω—ã–º –∫–ª–∏–∫–æ–º (protocol file://).<br>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª –Ω–∞ —Ö–æ—Å—Ç–∏–Ω–≥ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ª–æ–∫–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä (Live Server).", 
                false
            );
        }, 1000);
        log("–û–®–ò–ë–ö–ê: –ó–∞–ø—É—â–µ–Ω —Ñ–∞–π–ª –Ω–∞–ø—Ä—è–º—É—é (file://). –ù—É–∂–µ–Ω —Å–µ—Ä–≤–µ—Ä!", 'err');
    }

    // --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ---
    let savedKey = localStorage.getItem('custom_api_key');
    // –Ø —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–ª –∫–ª—é—á —Å–æ–≥–ª–∞—Å–Ω–æ –≤–∞—à–µ–º—É —Å–∫—Ä–∏–Ω—à–æ—Ç—É image_9d5b41.png
    let defaultKey = "AIzaSyBlFCYqHw_uHxP6pyKOkW0QFsuHFw9_XyY"; 

    let firebaseConfig = {
        apiKey: savedKey || defaultKey,
        authDomain: "durakweb3.firebaseapp.com",
        projectId: "durakweb3",
        storageBucket: "durakweb3.firebasestorage.app",
        messagingSenderId: "306514193440",
        appId: "1:306514193440:web:79d78252da6ee29c40a045"
    };

    if (typeof __firebase_config !== 'undefined') {
        firebaseConfig = JSON.parse(__firebase_config);
    }

    // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ---
    let app, auth, db;
    let myId = null;
    let myName = "";
    let gameId = null;
    let gameState = null;

    try {
        app = firebase.initializeApp(firebaseConfig);
        auth = firebase.auth();
        db = firebase.firestore();
        log("SDK –∑–∞–≥—Ä—É–∂–µ–Ω. Key: ..." + firebaseConfig.apiKey.slice(-5), 'ok');
    } catch(e) {
        log("–°–±–æ–π SDK: " + e.message, 'err');
    }

    // --- –í–•–û–î ---
    (async () => {
        try {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await auth.signInWithCustomToken(__initial_auth_token);
                log("–¢–æ–∫–µ–Ω –ø—Ä–∏–Ω—è—Ç", 'ok');
            } else {
                await auth.signInAnonymously();
                log("–í—Ö–æ–¥ —É—Å–ø–µ—à–µ–Ω", 'ok');
            }
        } catch (e) {
            log("–û–®–ò–ë–ö–ê –í–•–û–î–ê: " + e.code, 'err');
            
            if (e.code === 'auth/api-key-not-valid') {
                showModal(
                    "–ù–µ–≤–µ—Ä–Ω—ã–π API Key", 
                    "–ö–ª—é—á –¥–æ—Å—Ç—É–ø–∞ –Ω–µ–≤–µ—Ä–µ–Ω. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ <b>apiKey</b> –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫ Firebase –∏ –≤—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞:", 
                    true
                );
            } else if (e.code === 'auth/operation-not-allowed') {
                log("–í–∫–ª—é—á–∏—Ç–µ Anonymous –≤ –∫–æ–Ω—Å–æ–ª–∏!", 'warn');
                showModal("–û—à–∏–±–∫–∞ Auth", "–í–∫–ª—é—á–∏—Ç–µ 'Anonymous' (–ê–Ω–æ–Ω–∏–º–Ω—ã–π –≤—Ö–æ–¥) –≤ Firebase Console -> Authentication.", false);
            } else {
                log(e.message, 'err');
            }
        }
    })();

    auth.onAuthStateChanged((user) => {
        if (user) {
            myId = user.uid;
            log("–ì–æ—Ç–æ–≤. ID: " + myId.slice(0,4), 'ok');
            document.getElementById('btn-create').disabled = false;
            document.getElementById('btn-create').innerText = "–°–æ–∑–¥–∞—Ç—å –∏–≥—Ä—É";
            document.getElementById('btn-join').disabled = false;
            const saved = localStorage.getItem('durak_name');
            if (saved) document.getElementById('player-name').value = saved;
        }
    });

    // --- –ò–ì–†–ê ---
    function getGameRef(id) {
        if (typeof __app_id !== 'undefined') {
            return db.collection('artifacts').doc(__app_id).collection('public').doc('data').collection('durak_games').doc(id);
        }
        return db.collection('durak_games').doc(id);
    }

    async function createGame() {
        const name = document.getElementById('player-name').value.trim();
        if (!name) return log("–í–≤–µ–¥–∏—Ç–µ –∏–º—è", 'err');
        
        myName = name;
        localStorage.setItem('durak_name', myName);
        log("–°–æ–∑–¥–∞–µ–º –∏–≥—Ä—É...", 'info');

        try {
            const deck = generateDeck();
            const trump = deck[0];
            const playDeck = [...deck];
            const hand = [];
            for(let i=0; i<6; i++) hand.push(playDeck.pop());
            sortHand(hand, trump.suit);

            const newId = Math.random().toString(36).substr(2, 6).toUpperCase();
            
            await getGameRef(newId).set({
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                hostId: myId,
                status: 'waiting',
                deck: playDeck,
                trump: { rank: trump.rank, suit: trump.suit, isRed: isRed(trump.suit) },
                trumpSuit: trump.suit,
                players: { [myId]: { name: myName, hand: hand } },
                table: [],
                currentTurn: myId,
                defenderId: null,
                winner: null
            });

            gameId = newId;
            startGameListener();
        } catch (e) {
            log("–û—à–∏–±–∫–∞ –ë–î: " + e.message, 'err');
        }
    }

    async function joinGameInput() {
        const code = document.getElementById('join-code').value.trim().toUpperCase();
        const name = document.getElementById('player-name').value.trim();
        if (!code || !name) return log("–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∏ –∫–æ–¥", 'err');
        
        myName = name;
        localStorage.setItem('durak_name', myName);
        log("–í—Ö–æ–¥ –≤ " + code + "...", 'info');

        try {
            const ref = getGameRef(code);
            const doc = await ref.get();
            if (!doc.exists) throw new Error("–ò–≥—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");
            const data = doc.data();

            if (!data.players[myId]) {
                if (data.status !== 'waiting') throw new Error("–£–∂–µ –∏–≥—Ä–∞—é—Ç");
                const d = [...data.deck];
                const h = [];
                for(let i=0; i<6; i++) if(d.length) h.push(d.pop());
                sortHand(h, data.trumpSuit);
                
                await ref.update({
                    [`players.${myId}`]: { name: myName, hand: h },
                    deck: d,
                    status: 'playing',
                    defenderId: myId,
                    playerIds: [data.hostId, myId]
                });
            }
            gameId = code;
            startGameListener();
        } catch (e) {
            log(e.message, 'err');
        }
    }

    function startGameListener() {
        document.getElementById('menu-screen').style.display = 'none';
        document.getElementById('game-screen').style.display = 'flex';
        document.getElementById('ui-game-code').innerText = gameId;
        document.getElementById('ui-my-name').innerText = myName;

        getGameRef(gameId).onSnapshot((doc) => {
            if (!doc.exists) { alert("–ò–≥—Ä–∞ —É–¥–∞–ª–µ–Ω–∞"); location.reload(); return; }
            gameState = doc.data();
            renderGame();
        });
    }

    // --- –†–ï–ù–î–ï–† ---
    const SUITS = ['‚ô†', '‚ô£', '‚ô¶', '‚ô•'];
    const RANKS = ['6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A'];
    const VALUES = { '6':6, '7':7, '8':8, '9':9, '10':10, 'J':11, 'Q':12, 'K':13, 'A':14 };

    function renderGame() {
        if (!gameState) return;
        
        if (gameState.winner) {
            const winMsg = (gameState.winner === myId) ? "–ü–û–ë–ï–î–ê!" : "–ü–†–û–ò–ì–†–´–®";
            document.getElementById('status-display').style.display = 'block';
            document.getElementById('status-display').innerText = winMsg;
            document.getElementById('btn-action').innerText = "–ú–ï–ù–Æ";
            document.getElementById('btn-action').disabled = false;
            document.getElementById('btn-action').onclick = () => location.reload();
            return;
        }

        const oppId = Object.keys(gameState.players).find(id => id !== myId);
        if (oppId) {
            document.getElementById('ui-opp-name').innerText = gameState.players[oppId].name;
            renderCards('opponent-hand', gameState.players[oppId].hand, true);
        } else {
            document.getElementById('ui-opp-name').innerText = "–û–∂–∏–¥–∞–Ω–∏–µ...";
        }

        renderCards('player-hand', gameState.players[myId].hand, false);
        renderTable(gameState.table);
        renderDeck(gameState.deck.length, gameState.trump);
        updateControls();
    }

    function renderCards(elId, hand, isOpp) {
        const c = document.getElementById(elId);
        c.innerHTML = '';
        const limit = isOpp ? Math.min(hand.length, 8) : hand.length;
        
        for(let i=0; i<limit; i++) {
            const card = isOpp ? null : hand[i];
            const div = document.createElement('div');
            div.className = isOpp ? 'card card-back' : `card ${isRed(card.suit)?'red':'black'}`;
            
            if (!isOpp) {
                div.innerHTML = `
                    <div class="card-top-left"><div>${card.rank}</div><div>${card.suit}</div></div>
                    <div class="card-center">${card.suit}</div>
                    <div class="card-bottom-right"><div>${card.rank}</div><div>${card.suit}</div></div>
                `;
                div.onclick = () => onCardClick(card);
            } else {
                const off = (i - limit/2)*20;
                const rot = (i - limit/2)*5;
                div.style.position = 'absolute';
                div.style.transform = `translateX(${off}px) rotate(${rot}deg)`;
            }
            c.appendChild(div);
        }
    }

    function renderTable(table) {
        const c = document.getElementById('table');
        c.innerHTML = '';
        table.forEach(p => {
            const slot = document.createElement('div');
            slot.className = 'slot';
            slot.appendChild(createCardHTML(p.attack));
            if (p.defend) {
                const def = createCardHTML(p.defend);
                def.classList.add('defending');
                slot.appendChild(def);
            }
            c.appendChild(slot);
        });
    }

    function createCardHTML(card) {
        const div = document.createElement('div');
        div.className = `card ${isRed(card.suit)?'red':'black'}`;
        div.innerHTML = `
            <div class="card-top-left"><div>${card.rank}</div><div>${card.suit}</div></div>
            <div class="card-center">${card.suit}</div>
            <div class="card-bottom-right"><div>${card.rank}</div><div>${card.suit}</div></div>
        `;
        return div;
    }

    function renderDeck(count, trump) {
        const ph = document.getElementById('trump-placeholder');
        ph.innerHTML = '';
        if (count > 0 || (count===0 && trump)) {
            const t = createCardHTML(trump);
            t.className += ' trump-card-container';
            ph.appendChild(t);
        }
        document.getElementById('deck-count').innerText = count > 0 ? count : "";
        document.getElementById('deck-count').style.display = count > 0 ? 'flex' : 'none';
    }

    function updateControls() {
        const btn = document.getElementById('btn-action');
        const st = document.getElementById('status-display');
        st.style.display = 'none';
        
        if (gameState.status === 'waiting') {
            btn.innerText = "–ñ–¥–µ–º –∏–≥—Ä–æ–∫–∞..."; btn.disabled = true; return;
        }

        const isMyTurn = gameState.currentTurn === myId;
        const isDef = gameState.defenderId === myId;
        btn.disabled = false;
        btn.onclick = doAction;

        if (isMyTurn) {
            const allBeaten = gameState.table.length > 0 && gameState.table.every(p => p.defend);
            if (allBeaten) {
                btn.innerText = "–ë–ò–¢–û"; btn.onclick = actionBito;
                btn.style.background = "#4cd137";
                st.innerText = "–ú–æ–∂–Ω–æ –∑–∞–∫–æ–Ω—á–∏—Ç—å —Ö–æ–¥"; st.style.display = 'block';
            } else if (gameState.table.length === 0) {
                btn.innerText = "–ö–∏–¥–∞–π –∫–∞—Ä—Ç—É"; btn.disabled = true; btn.style.background = "#ffcc00";
                st.innerText = "–í–∞—à —Ö–æ–¥"; st.style.display = 'block';
            } else {
                btn.innerText = "–ñ–¥–µ–º..."; btn.disabled = true; btn.style.background = "#ffcc00";
                st.innerText = "–ñ–¥–µ–º –∑–∞—â–∏—Ç—ã"; st.style.display = 'block';
            }
        } else if (isDef) {
            btn.innerText = "–í–ó–Ø–¢–¨"; btn.onclick = actionTake;
            btn.style.background = "#e84118";
            st.innerText = "–û—Ç–±–∏–≤–∞–π—Ç–µ—Å—å"; st.style.display = 'block';
        } else {
            btn.innerText = "..."; btn.disabled = true;
        }
    }

    function doAction() { tg.showAlert("–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ"); }

    function onCardClick(card) {
        if (gameState.status !== 'playing') return;
        const isMyTurn = gameState.currentTurn === myId;
        const isDef = gameState.defenderId === myId;

        if (isMyTurn) {
            if (gameState.table.length >= 6) return;
            if (gameState.table.length > 0) {
                const ranks = gameState.table.flatMap(p => [p.attack.rank, p.defend?.rank]).filter(r=>r);
                if (!ranks.includes(card.rank)) return tg.showAlert("–¢–æ–ª—å–∫–æ –∫–∞—Ä—Ç—ã —Ç–æ–≥–æ –∂–µ —Ä–∞–Ω–≥–∞");
            }
            const oppId = Object.keys(gameState.players).find(id => id !== myId);
            const oppHand = gameState.players[oppId].hand.length;
            const active = gameState.table.filter(p => !p.defend).length;
            if (active + 1 > oppHand) return tg.showAlert("–£ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞ –º–∞–ª–æ –∫–∞—Ä—Ç");
            playCard(card, 'attack');
        } else if (isDef) {
            const idx = gameState.table.findIndex(p => !p.defend);
            if (idx === -1) return;
            const att = gameState.table[idx].attack;
            if (canBeat(card, att, gameState.trumpSuit)) playCard(card, 'defend', idx);
            else tg.showAlert("–ù–µ –±—å–µ—Ç!");
        }
    }

    async function playCard(card, type, idx) {
        const ref = getGameRef(gameId);
        const newHand = gameState.players[myId].hand.filter(c => !(c.rank===card.rank && c.suit===card.suit));
        const newTable = [...gameState.table];
        if (type === 'attack') newTable.push({attack:card, defend:null});
        else newTable[idx].defend = card;
        await ref.update({ [`players.${myId}.hand`]: newHand, table: newTable });
    }

    async function actionBito() {
        const ref = getGameRef(gameId);
        const attId = myId; const defId = gameState.defenderId;
        let d = [...gameState.deck];
        let h1 = [...gameState.players[attId].hand], h2 = [...gameState.players[defId].hand];
        while(h1.length < 6 && d.length) h1.push(d.pop());
        while(h2.length < 6 && d.length) h2.push(d.pop());
        sortHand(h1, gameState.trumpSuit); sortHand(h2, gameState.trumpSuit);
        let win = (!d.length && !h1.length) ? attId : (!d.length && !h2.length ? defId : null);
        await ref.update({ table: [], deck: d, [`players.${attId}.hand`]: h1, [`players.${defId}.hand`]: h2, currentTurn: defId, defenderId: attId, winner: win });
    }

    async function actionTake() {
        const ref = getGameRef(gameId);
        const cards = gameState.table.flatMap(p => [p.attack, p.defend]).filter(c=>c);
        let h = [...gameState.players[myId].hand, ...cards];
        sortHand(h, gameState.trumpSuit);
        const attId = gameState.currentTurn;
        let d = [...gameState.deck];
        let ah = [...gameState.players[attId].hand];
        while(ah.length < 6 && d.length) ah.push(d.pop());
        let win = (!d.length && !ah.length) ? attId : null;
        await ref.update({ table: [], deck: d, [`players.${myId}.hand`]: h, [`players.${attId}.hand`]: ah, winner: win });
    }

    function generateDeck() {
        let d=[]; for(let s of SUITS) for(let r of RANKS) d.push({rank:r, suit:s});
        return d.sort(()=>Math.random()-0.5);
    }
    function sortHand(h, t) { h.sort((a,b) => (VALUES[a.rank]+(a.suit===t?100:0)) - (VALUES[b.rank]+(b.suit===t?100:0))); }
    function isRed(s) { return s==='‚ô¶'||s==='‚ô•'; }
    function canBeat(c, t, tr) { return (c.suit===t.suit && VALUES[c.rank]>VALUES[t.rank]) || c.suit===tr && t.suit!==tr; }
    function copyCode() { navigator.clipboard.writeText(gameId); tg.showAlert("–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ"); }
</script>
</body>
</html>
