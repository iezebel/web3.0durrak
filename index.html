<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Durak Online</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- Используем стабильную версию Firebase Compat -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

    <style>
        /* --- СТИЛИ --- */
        :root {
            --bg-color: #2a5c32;
            --bg-pattern: #1a3c22;
            --btn-color: #ffcc00;
        }

        body {
            margin: 0; padding: 0;
            background-color: var(--bg-color);
            background-image: radial-gradient(circle at center, var(--bg-color) 0%, var(--bg-pattern) 100%);
            color: white;
            font-family: -apple-system, sans-serif;
            overflow: hidden;
            display: flex; flex-direction: column;
            height: 100vh;
            user-select: none; -webkit-user-select: none;
        }

        #menu-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(20, 40, 25, 0.95);
            z-index: 2000;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            gap: 15px;
        }

        .menu-title {
            font-size: 42px; font-weight: 900; color: var(--btn-color);
            margin-bottom: 20px; text-transform: uppercase;
        }

        input {
            padding: 15px; border-radius: 12px;
            border: 2px solid rgba(255,255,255,0.2);
            background: rgba(0,0,0,0.3);
            color: white; font-size: 18px; text-align: center;
            width: 250px; outline: none; margin-bottom: 10px;
        }

        .menu-btn {
            background: var(--btn-color); color: #2e2e2e;
            border: none; padding: 15px 40px; border-radius: 12px;
            font-size: 18px; font-weight: 800; cursor: pointer;
            width: 280px; text-transform: uppercase;
            box-shadow: 0 4px 0 #c29d00;
        }
        .menu-btn:active { transform: translateY(4px); box-shadow: none; }
        .menu-btn:disabled { background: #555; color: #888; box-shadow: none; cursor: wait; }

        .row { display: flex; gap: 10px; width: 280px; justify-content: center;}

        /* КОНСОЛЬ ОТЛАДКИ (чтобы видеть ошибки) */
        #debug-console {
            margin-top: 20px;
            font-family: monospace;
            font-size: 12px;
            color: #00ff00;
            background: rgba(0,0,0,0.8);
            padding: 10px;
            border-radius: 8px;
            width: 90%;
            max-width: 400px;
            height: 150px;
            overflow-y: auto;
            text-align: left;
            border: 1px solid #333;
        }
        .log-err { color: #ff5555; }
        .log-ok { color: #55ff55; }
        .log-info { color: #aaa; }

        /* Игровой экран */
        #game-screen {
            display: none; flex: 1; position: relative;
            flex-direction: column; height: 100%;
        }

        /* Карты */
        .card {
            width: 70px; height: 100px;
            background: white; border-radius: 8px; color: black;
            position: relative; box-shadow: 0 2px 5px rgba(0,0,0,0.5);
            margin-right: -25px; cursor: pointer;
        }
        .card.red { color: #d40000; }
        .card-top-left { position: absolute; top: 4px; left: 4px; font-size: 14px; line-height: 1; text-align: center; }
        .card-bottom-right { position: absolute; bottom: 4px; right: 4px; font-size: 14px; line-height: 1; text-align: center; transform: rotate(180deg); }
        .card-center { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 32px; }
        .card-back { background: #4a7c59; border: 2px solid white; background-image: repeating-linear-gradient(45deg, #4a7c59 0, #4a7c59 10px, #3b6346 10px, #3b6346 20px); }

        .hand { display: flex; justify-content: center; height: 110px; width: 100%; position: relative; }
        .opponent-hand { margin-top: 10px; }
        .player-hand { margin-bottom: 80px; overflow-x: auto; padding: 0 20px; justify-content: flex-start; }
        .table-area { flex: 1; display: flex; justify-content: center; align-items: center; position: relative; }
        .table-slots { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; padding-left: 80px;}
        .slot { width: 70px; height: 100px; position: relative; }
        .slot .card { position: absolute; top: 0; left: 0; }
        .slot .defending { top: 15px; left: 15px; transform: rotate(15deg); z-index: 10; }
        
        .deck-area { position: absolute; left: 20px; top: 50%; transform: translateY(-50%); }
        .deck-stack { width: 70px; height: 100px; background: #1a3c22; border: 2px solid white; border-radius: 8px; display: flex; justify-content: center; align-items: center; font-weight: bold; font-size: 20px; z-index: 2; position: relative;}
        .trump-card-container { position: absolute; top: 0; left: 20px; width: 70px; height: 100px; transform: rotate(90deg) translateX(-20px); z-index: 1; }

        .top-bar { padding: 10px; background: rgba(0,0,0,0.3); display: flex; justify-content: space-between; }
        .controls { position: absolute; bottom: 20px; width: 100%; display: flex; justify-content: center; pointer-events: none; }
        .game-btn { pointer-events: auto; background: var(--btn-color); border: none; padding: 12px 40px; border-radius: 30px; font-size: 18px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 0 #c29d00; }
        .game-btn:active { transform: translateY(4px); box-shadow: none; }
        .game-btn:disabled { background: #888; color: #ccc; cursor: not-allowed; }
        .status-msg { position: absolute; top: 40%; width: 100%; text-align: center; background: rgba(0,0,0,0.5); padding: 10px; font-size: 20px; font-weight: bold; display: none; }
    </style>
</head>
<body>

    <!-- МЕНЮ С ЛОГАМИ -->
    <div id="menu-screen">
        <div class="menu-title">Durak Online</div>
        
        <input type="text" id="player-name" placeholder="Ваше имя" maxlength="12">
        
        <button id="btn-create" class="menu-btn" onclick="createGame()" disabled>Загрузка...</button>
        
        <div class="row">
            <input type="text" id="join-code" placeholder="Код" style="width: 100px; margin:0;">
            <button id="btn-join" class="menu-btn" onclick="joinGameInput()" style="width: 160px;" disabled>Войти</button>
        </div>

        <div id="debug-console">
            <div class="log-info">Инициализация системы...</div>
        </div>
    </div>

    <!-- ИГРА -->
    <div id="game-screen">
        <div class="top-bar">
            <div>Я: <b id="ui-my-name">...</b></div>
            <div onclick="copyCode()" style="cursor:pointer; background:rgba(255,255,255,0.2); padding:2px 8px; border-radius:4px;">ID: <span id="ui-game-code">...</span></div>
            <div>Враг: <b id="ui-opp-name">...</b></div>
        </div>

        <div class="table-area">
            <div class="deck-area">
                <div id="trump-placeholder"></div>
                <div class="deck-stack" id="deck-count"></div>
            </div>
            <div class="table-slots" id="table"></div>
        </div>

        <div class="status-msg" id="status-display"></div>

        <div class="hand opponent-hand" id="opponent-hand"></div>
        <div class="hand player-hand" id="player-hand"></div>

        <div class="controls">
            <button id="btn-action" class="game-btn" onclick="doAction()">...</button>
        </div>
    </div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    // --- ФУНКЦИЯ ЛОГИРОВАНИЯ ---
    function log(msg, type='info') {
        const consoleEl = document.getElementById('debug-console');
        const line = document.createElement('div');
        line.className = `log-${type}`;
        line.innerText = `> ${msg}`;
        consoleEl.appendChild(line);
        consoleEl.scrollTop = consoleEl.scrollHeight;
        console.log(`[${type.toUpperCase()}] ${msg}`);
    }

    // --- КОНФИГУРАЦИЯ ---
    let firebaseConfig = {
        apiKey: "AIzaSyBlFCYqHw_uHxP6pyKOkW0QFsuHFw9_XyY",
        authDomain: "durakweb3.firebaseapp.com",
        projectId: "durakweb3",
        storageBucket: "durakweb3.firebasestorage.app",
        messagingSenderId: "306514193440",
        appId: "1:306514193440:web:79d78252da6ee29c40a045"
    };

    if (typeof __firebase_config !== 'undefined') {
        firebaseConfig = JSON.parse(__firebase_config);
        log("Используется конфиг редактора", 'info');
    } else {
        log("Используется конфиг DurakWeb3", 'info');
    }

    // --- ИНИЦИАЛИЗАЦИЯ ---
    let app, auth, db;
    let myId = null;
    let myName = "";
    let gameId = null;
    let gameState = null;

    try {
        app = firebase.initializeApp(firebaseConfig);
        auth = firebase.auth();
        db = firebase.firestore();
        log("Firebase SDK загружен", 'ok');
    } catch(e) {
        log("Ошибка иниц. Firebase: " + e.message, 'err');
    }

    // --- ВХОД ---
    (async () => {
        log("Попытка входа...", 'info');
        try {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await auth.signInWithCustomToken(__initial_auth_token);
                log("Вход по токену успешен", 'ok');
            } else {
                await auth.signInAnonymously();
                log("Анонимный вход выполнен", 'ok');
            }
        } catch (e) {
            log("ОШИБКА ВХОДА: " + e.message, 'err');
            log("Совет: Включите 'Anonymous' в Firebase Console", 'info');
            log("Совет: Не запускайте файл просто так, используйте сервер", 'info');
        }
    })();

    auth.onAuthStateChanged((user) => {
        if (user) {
            myId = user.uid;
            log("ID пользователя: " + myId.slice(0,5)+"...", 'ok');
            
            // Разблокируем кнопки
            document.getElementById('btn-create').disabled = false;
            document.getElementById('btn-create').innerText = "Создать игру";
            document.getElementById('btn-join').disabled = false;
            
            const savedName = localStorage.getItem('durak_name');
            if (savedName) document.getElementById('player-name').value = savedName;
        } else {
            log("Пользователь вышел", 'info');
        }
    });

    // --- ФУНКЦИИ ИГРЫ ---
    
    // Определяем коллекцию
    function getGameRef(id) {
        if (typeof __app_id !== 'undefined') {
            return db.collection('artifacts').doc(__app_id).collection('public').doc('data').collection('durak_games').doc(id);
        }
        return db.collection('durak_games').doc(id);
    }

    async function createGame() {
        const nameInput = document.getElementById('player-name').value.trim();
        if (!nameInput) return log("Введите имя!", 'err');
        
        log("Создание игры...", 'info');
        myName = nameInput;
        localStorage.setItem('durak_name', myName);

        try {
            const newDeck = generateDeck();
            const trumpCard = newDeck[0]; 
            const deckToPlay = [...newDeck];
            const initialHand = [];
            for(let i=0; i<6; i++) initialHand.push(deckToPlay.pop());
            sortHand(initialHand, trumpCard.suit);

            const newGameId = Math.random().toString(36).substr(2, 6).toUpperCase();
            
            await getGameRef(newGameId).set({
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                hostId: myId,
                status: 'waiting',
                deck: deckToPlay,
                trump: { rank: trumpCard.rank, suit: trumpCard.suit, isRed: isRed(trumpCard.suit) },
                trumpSuit: trumpCard.suit,
                players: { [myId]: { name: myName, hand: initialHand } },
                table: [],
                currentTurn: myId, 
                defenderId: null,
                winner: null
            });

            log("Игра создана: " + newGameId, 'ok');
            gameId = newGameId;
            startGameListener();

        } catch (e) {
            log("Ошибка создания: " + e.message, 'err');
        }
    }

    async function joinGameInput() {
        const code = document.getElementById('join-code').value.trim().toUpperCase();
        const nameInput = document.getElementById('player-name').value.trim();
        if (!code) return log("Нет кода!", 'err');
        
        log("Подключение к " + code + "...", 'info');
        myName = nameInput;
        localStorage.setItem('durak_name', myName);

        try {
            const gameRef = getGameRef(code);
            const doc = await gameRef.get();

            if (!doc.exists) throw new Error("Не найдено");
            const data = doc.data();

            if (!data.players[myId]) {
                if (data.status !== 'waiting') throw new Error("Игра уже идет");
                
                const deck = [...data.deck];
                const myHand = [];
                for(let i=0; i<6; i++) if(deck.length > 0) myHand.push(deck.pop());
                sortHand(myHand, data.trumpSuit);
                
                await gameRef.update({
                    [`players.${myId}`]: { name: myName, hand: myHand },
                    deck: deck,
                    status: 'playing',
                    defenderId: myId,
                    playerIds: [data.hostId, myId]
                });
            }
            gameId = code;
            startGameListener();
        } catch (e) {
            log("Ошибка входа: " + e.message, 'err');
        }
    }

    function startGameListener() {
        document.getElementById('menu-screen').style.display = 'none';
        document.getElementById('game-screen').style.display = 'flex';
        document.getElementById('ui-game-code').innerText = gameId;
        document.getElementById('ui-my-name').innerText = myName;

        getGameRef(gameId).onSnapshot((doc) => {
            if (!doc.exists) { alert("Игра удалена"); location.reload(); return; }
            gameState = doc.data();
            renderGame();
        }, (error) => {
             console.error(error);
             // Если ошибка прав доступа
             if (error.code === 'permission-denied') {
                 alert("Ошибка прав доступа! Проверьте Firestore Rules.");
             }
        });
    }

    // --- ГРАФИКА И ЛОГИКА ---
    // (Стандартная логика дурака, сокращена для компактности)
    const SUITS = ['♠', '♣', '♦', '♥'];
    const RANKS = ['6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A'];
    const VALUES = { '6':6, '7':7, '8':8, '9':9, '10':10, 'J':11, 'Q':12, 'K':13, 'A':14 };

    function renderGame() {
        if (!gameState) return;
        
        // Победа
        if (gameState.winner) {
            const msg = (gameState.winner === myId) ? "ПОБЕДА!" : "ПРОИГРЫШ";
            document.getElementById('status-display').style.display = 'block';
            document.getElementById('status-display').innerText = msg;
            document.getElementById('btn-action').innerText = "ВЫХОД";
            document.getElementById('btn-action').onclick = () => location.reload();
            return;
        }

        const oppId = Object.keys(gameState.players).find(id => id !== myId);
        if (oppId) {
            document.getElementById('ui-opp-name').innerText = gameState.players[oppId].name;
            renderCards('opponent-hand', gameState.players[oppId].hand, true);
        } else {
            document.getElementById('ui-opp-name').innerText = "Ждем...";
        }

        renderCards('player-hand', gameState.players[myId].hand, false);
        renderTable(gameState.table);
        renderDeck(gameState.deck.length, gameState.trump);
        updateControls();
    }

    function renderCards(elementId, hand, isOpponent) {
        const container = document.getElementById(elementId);
        container.innerHTML = '';
        const count = hand.length;
        const visualCount = isOpponent ? Math.min(count, 8) : count;
        
        for(let i=0; i<visualCount; i++) {
            const card = isOpponent ? null : hand[i];
            const el = document.createElement('div');
            el.className = isOpponent ? 'card card-back' : `card ${isRed(card.suit)?'red':'black'}`;
            
            if (!isOpponent) {
                el.innerHTML = `
                    <div class="card-top-left"><div>${card.rank}</div><div>${card.suit}</div></div>
                    <div class="card-center">${card.suit}</div>
                    <div class="card-bottom-right"><div>${card.rank}</div><div>${card.suit}</div></div>
                `;
                el.onclick = () => onCardClick(card);
            }
            // Веер
            if (isOpponent) {
                const off = (i - visualCount/2)*20;
                const rot = (i - visualCount/2)*5;
                el.style.position = 'absolute';
                el.style.transform = `translateX(${off}px) rotate(${rot}deg)`;
            }
            container.appendChild(el);
        }
    }

    function renderTable(table) {
        const container = document.getElementById('table');
        container.innerHTML = '';
        table.forEach(pair => {
            const slot = document.createElement('div');
            slot.className = 'slot';
            const att = createCard(pair.attack);
            slot.appendChild(att);
            if(pair.defend) {
                const def = createCard(pair.defend);
                def.classList.add('defending');
                slot.appendChild(def);
            }
            container.appendChild(slot);
        });
    }

    function createCard(card) {
        const el = document.createElement('div');
        el.className = `card ${isRed(card.suit)?'red':'black'}`;
        el.innerHTML = `
            <div class="card-top-left"><div>${card.rank}</div><div>${card.suit}</div></div>
            <div class="card-center">${card.suit}</div>
            <div class="card-bottom-right"><div>${card.rank}</div><div>${card.suit}</div></div>
        `;
        return el;
    }

    function renderDeck(count, trump) {
        const ph = document.getElementById('trump-placeholder');
        ph.innerHTML = '';
        if (count > 0 || (count===0 && trump)) {
            const el = createCard(trump);
            el.className += ' trump-card-container';
            ph.appendChild(el);
        }
        document.getElementById('deck-count').innerText = count > 0 ? count : "";
        document.getElementById('deck-count').style.display = count > 0 ? 'flex' : 'none';
    }

    function updateControls() {
        const btn = document.getElementById('btn-action');
        const st = document.getElementById('status-display');
        st.style.display = 'none';
        
        if (gameState.status === 'waiting') {
            btn.innerText = "Ждем игрока..."; btn.disabled = true; return;
        }

        const isMyTurn = gameState.currentTurn === myId;
        const isDefender = gameState.defenderId === myId;
        btn.disabled = false;

        if (isMyTurn) {
            if (gameState.table.length > 0 && gameState.table.every(p => p.defend)) {
                btn.innerText = "БИТО"; btn.onclick = actionBito;
                btn.style.background = "#4cd137";
            } else {
                btn.innerText = "Кидай карту"; btn.disabled = true; btn.style.background = "#ffcc00";
            }
        } else if (isDefender) {
            btn.innerText = "ВЗЯТЬ"; btn.onclick = actionTake;
            btn.style.background = "#e84118";
        } else {
            btn.innerText = "Смотрим..."; btn.disabled = true;
        }
    }

    // --- ЛОГИКА ХОДОВ ---
    function doAction() { tg.showAlert("Выберите карту или кнопку"); }

    function onCardClick(card) {
        if (gameState.status !== 'playing') return;
        const isMyTurn = gameState.currentTurn === myId;
        const isDefender = gameState.defenderId === myId;

        if (isMyTurn) {
            // Атака
            if (gameState.table.length >= 6) return;
            if (gameState.table.length > 0) {
                const ranks = gameState.table.flatMap(p => [p.attack.rank, p.defend?.rank]).filter(r=>r);
                if (!ranks.includes(card.rank)) return tg.showAlert("Нет такой карты на столе");
            }
            playCard(card, 'attack');
        } else if (isDefender) {
            // Защита
            const idx = gameState.table.findIndex(p => !p.defend);
            if (idx === -1) return;
            const att = gameState.table[idx].attack;
            if (canBeat(card, att, gameState.trumpSuit)) playCard(card, 'defend', idx);
            else tg.showAlert("Не бьет!");
        }
    }

    async function playCard(card, type, idx) {
        const ref = getGameRef(gameId);
        const newHand = gameState.players[myId].hand.filter(c => !(c.rank===card.rank && c.suit===card.suit));
        const newTable = [...gameState.table];
        if (type === 'attack') newTable.push({attack:card, defend:null});
        else newTable[idx].defend = card;
        
        await ref.update({ [`players.${myId}.hand`]: newHand, table: newTable });
    }

    async function actionBito() {
        const ref = getGameRef(gameId);
        const attId = myId;
        const defId = gameState.defenderId;
        // Добор
        let deck = [...gameState.deck];
        let h1 = [...gameState.players[attId].hand], h2 = [...gameState.players[defId].hand];
        while(h1.length < 6 && deck.length) h1.push(deck.pop());
        while(h2.length < 6 && deck.length) h2.push(deck.pop());
        sortHand(h1, gameState.trumpSuit); sortHand(h2, gameState.trumpSuit);

        let win = null;
        if (!deck.length && !h1.length) win = attId;
        else if (!deck.length && !h2.length) win = defId;

        await ref.update({
            table: [], deck: deck,
            [`players.${attId}.hand`]: h1, [`players.${defId}.hand`]: h2,
            currentTurn: defId, defenderId: attId, winner: win
        });
    }

    async function actionTake() {
        const ref = getGameRef(gameId);
        const cards = gameState.table.flatMap(p => [p.attack, p.defend]).filter(c=>c);
        let myH = [...gameState.players[myId].hand, ...cards];
        sortHand(myH, gameState.trumpSuit);

        // Атакующий добирает
        const attId = gameState.currentTurn;
        let deck = [...gameState.deck];
        let attH = [...gameState.players[attId].hand];
        while(attH.length < 6 && deck.length) attH.push(deck.pop());
        
        let win = null;
        if (!deck.length && !attH.length) win = attId;

        await ref.update({
            table: [], deck: deck,
            [`players.${myId}.hand`]: myH, [`players.${attId}.hand`]: attH,
            winner: win
        });
    }

    // --- УТИЛИТЫ ---
    function generateDeck() {
        let d=[]; for(let s of SUITS) for(let r of RANKS) d.push({rank:r, suit:s});
        return d.sort(()=>Math.random()-0.5);
    }
    function sortHand(h, t) {
        h.sort((a,b) => (VALUES[a.rank]+(a.suit===t?100:0)) - (VALUES[b.rank]+(b.suit===t?100:0)));
    }
    function isRed(s) { return s==='♦'||s==='♥'; }
    function canBeat(c, t, tr) {
        if (c.suit === t.suit) return VALUES[c.rank] > VALUES[t.rank];
        return c.suit === tr;
    }
    function copyCode() {
        navigator.clipboard.writeText(gameId);
        tg.showAlert("Скопировано");
    }

</script>
</body>
</html>
